id: mep_collared_report
requirements:
  - name: ecoscope-workflows-core
    version: "0.20.6.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-ecoscope
    version: "0.20.6.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-custom
    version: "0.0.23.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/
    
  - name: ecoscope-workflows-ext-ste
    version: "0.0.10.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

  - name: ecoscope-workflows-ext-mnc
    version: "0.0.2.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

  - name: ecoscope-workflows-ext-mep
    version: "*"
    channel: file:///tmp/ecoscope-workflows-custom/release/artifacts/

rjsf-overrides:
  properties: 
    Subject Group.properties.subject_group_var.properties.var.title: Subject Group Name
    Subject Group..properties.subject_group_var.properties.var.default: subject_name

  $defs:
    # Restrict category options to Subject Name only
    ValueGrouper.oneOf:
      - const: subject_name
        title: Subject Name

task-instance-defaults:
  skipif:
    conditions:
      - any_is_empty_df
      - any_dependency_skipped

workflow:
  # set workflow details 
  - name: Set workflow details
    id: workflow_details
    task: set_workflow_details

  # define time range 
  - name: Define analysis time range 
    id: time_range 
    task: set_time_range 
    
  # set groupers -- limiting this to subject_name
  - name: Configure grouping strategy 
    id: groupers 
    task: set_custom_groupers
    partial:
      groupers: []
  
  # set basemaps
  - name: Configure base map layers 
    id: configure_base_maps 
    task: set_base_maps_pydeck

  # connect to earthranger
  - name: Connect to earth ranger
    id: er_client_name
    task: set_er_connection 
  
  # connect to earthengine 
  - name: Connect to earth engine 
    id: gee_project_name
    task: set_gee_connection 
  
  # Please note that this workflow only uses ldx db 
  - name: Load landDx database
    id: retrieve_ldx_db
    task: get_file_path 
    partial: 
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
  
  - name: Load ldx gpkg 
    id: load_ldx 
    task: load_df 
    partial: 
      file_path: ${{ workflow.retrieve_ldx_db.return }}
      layer: landDx_polygons
      deserialize_json: false 
    
  - name: Filter loaded landDx by AOI 
    id: filter_ldx_aoi 
    task: filter_row_values
    partial: 
      df: ${{ workflow.load_ldx.return }}
      column: type 
      values: 
        - Community Conservancy 
        - National Reserve 
        - National Park
    
  - name: Exclude unnecessary columns from ldx gdf 
    id: filter_ldx_cols 
    task: filter_df_cols 
    partial: 
      df: ${{ workflow.filter_ldx_aoi.return }}
      columns: 
        - type
        - name
        - geometry
      
  - name: Split ldx gdf by type column 
    id: split_ldx_by_type 
    task: split_gdf_by_column
    partial: 
      gdf: ${{ workflow.filter_ldx_cols.return }}
      column: type 
  
  - name: Annotate gdf dict with geom type 
    id: annotate_gdf_dict 
    task: annotate_gdf_dict_with_geom_type 
    partial: 
      gdf_dict: ${{ workflow.split_ldx_by_type.return }}

  - name: Create deckgl layers from split ldx gdf dict
    id: create_ldx_styled_layers 
    task: create_deckgl_layers_from_gdf_dict
    partial: 
      gdf_dict: ${{ workflow.annotate_gdf_dict.return }}
      styles: 
        Community Conservancy:
          get_fill_color: [166,182,151]
          get_line_color: [166,182,151]
          opacity: 0.15
          stroked: true
          get_line_width: 2.00 #1.85
          
        National Reserve:
          get_fill_color: [136,167,142]
          get_line_color: [136,167,142]
          opacity: 0.15
          stroked: true
          get_line_width: 2.00

        National Park: 
          get_fill_color: [17, 86, 49]
          get_line_color: [17, 86, 49]
          opacity: 0.15
          stroked: true
          get_line_width: 2.00
    
      legends: 
        title: "" 
        values: 
          - label: Community Conservancy 
            color: "#a6b697"
          - label: National Reserve 
            color: "#88a78e"
          - label: National Park 
            color: "#115631"


# get events -- elephant sighting and persist file 
  - name: Retrieve all events 
    id: get_events_data
    task: get_events
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      event_columns:
        - id
        - time
        - event_type
        - event_category
        - reported_by
        - serial_number
        - geometry
        - created_at
        - event_details
      event_types:
        - mep_elephant_sighting
      raise_on_empty: true
      include_details: true
      include_updates: false
      include_related_events: false
      include_null_geometry: false
      include_display_values: false

  - name: Exclude geom outliers from mep elephant sighting events
    id: exclude_mep_outliers
    task: exclude_geom_outliers
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial: 
      df: ${{ workflow.get_events_data.return }}
      z_threshold: 3

  - name: Remove elephant sightinginvalid points 
    id: remove_mep_invalid_geoms 
    task: ecoscope_workflows_ext_custom.tasks.transformation.drop_null_geometry
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial: 
      gdf: ${{ workflow.exclude_mep_outliers.return }}
      geometry_column: geometry 

  - name: Generate elephant sighting point layers
    id: generate_mb_layers
    task: create_scatterplot_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        get_fill_color: [85, 107, 47]
        get_radius: 5
        opacity: 0.75
        stroked: false
      legend:
        title: Elephant sightings 
        values: #556b2f
          - label: Sighting 
            color: "#556b2f"
      geodataframe: ${{ workflow.remove_mep_invalid_geoms.return }}
  
  # global zoom value 
  - name: Elephant sightings zoom value
    id: sighting_zoom_value
    task: view_state_deck_gdf
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      pitch: 0
      bearing: 0
      gdf: ${{ workflow.remove_mep_invalid_geoms.return }}

  - name: Combine styled layers with elephant sightings
    id: custom_elephant_sightings
    task: combine_deckgl_map_layers
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      static_layers: 
        - ${{ workflow.create_ldx_styled_layers.return }}
      grouped_layers: ${{ workflow.generate_mb_layers.return }}

  - name: Draw elephant sightings map
    id: draw_sightings_map
    task: draw_map
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null
      max_zoom: 10
      legend_style:
        placement: "bottom-right"
      geo_layers: ${{ workflow.custom_elephant_sightings.return }}
      view_state: ${{ workflow.sighting_zoom_value.return }} 

  - name: Persist elephant sightings map
    id: persist_sightings_urls
    task: persist_text
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      text: ${{ workflow.draw_sightings_map.return }}
      filename: elephant_sightings_map.html  # -- convert this to png 

# get relocations  -- collar voltages for subjects and persist file
  - title: Subject Group
    type: task-group
    description: Choose subject group to generate collar voltage charts and overall speedmap
    tasks:
      - name: null
        id: subject_group_var
        task: set_string_var

  - name: Get subject group observations 
    id: subject_observations
    task: get_subjectgroup_observations
    partial: 
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      subject_group_name: ${{ workflow.subject_group_var.return }}
      raise_on_empty: false 
      include_details: true
      include_subjectsource_details: true

  - name: Transform observations to relocations 
    id: subject_reloc
    task: process_relocations 
    partial: 
      observations: ${{ workflow.subject_observations.return }}
      relocs_columns: 
        - groupby_col
        - fixtime
        - junk_status 
        - geometry
        - extra__subject__name
        - extra__subject__hex
        - extra__subject__sex
        - extra__created_at
        - extra__subject__subject_subtype
        - extra__subjectsource__id
        - extra__subjectsource__assigned_range
        - extra__observation_details

      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  - name: Create collared charts for all subjects 
    id: process_subject_charts 
    task: process_collar_voltage_charts 
    partial: 
      relocs: ${{ workflow.subject_observations.return }}
      time_range: ${{ workflow.time_range.return }}
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }} # convert outputs to png 
  
# relocs to trajectories -- speedmap and persist file 
  - name: Trajectory Segment Filter  
    id: custom_trajs_filter
    task: custom_trajectory_segment_filter

  - name: Convert relocations to trajectories 
    id: convert_to_trajectories 
    task: relocations_to_trajectory 
    partial: 
      relocations: ${{ workflow.subject_reloc.return }}
      trajectory_segment_filter: ${{ workflow.custom_trajs_filter.return }}

  - name: Add temporal index to trajectories 
    id: add_temporal_index_to_traj 
    task: add_temporal_index
    partial: 
      df: ${{ workflow.convert_to_trajectories.return }}
      time_col: segment_start 
      groupers: ${{ workflow.groupers.return }}
      cast_to_datetime: true 
      format: mixed 

  - name: Classify trajectories by speed 
    id: classify_trajectories_speed_bins 
    task: apply_classification 
    partial: 
      df: ${{ workflow.add_temporal_index_to_traj.return }}
      input_column_name: speed_kmhr
      output_column_name: speed_bins
      classification_options: 
        scheme: equal_interval 
        k: 6 
      label_options:
        label_ranges: true
        label_decimals: 1
        label_suffix: ' km/h'
  
  - name: Sort trajectories by speed bins 
    id: sort_trajs_by_speed 
    task: sort_values
    partial: 
      column_name: speed_bins 
      na_position: first 
      ascending: true 
      df: ${{ workflow.classify_trajectories_speed_bins.return }}

  - name: Apply colormap to speed bins 
    id: apply_speed_colormap 
    task: apply_color_map 
    partial: 
      input_column_name: speed_bins
      output_column_name: speed_bins_colormap 
      colormap: 
        - '#1a9850'
        - '#91cf60'
        - '#d9ef8b'
        - '#fee08b'
        - '#fc8d59'
        - '#d73027'
      df: ${{ workflow.sort_trajs_by_speed.return }}
      
  - name: Exclude unnecessary columns from speedmap gdf 
    id: filter_speed_cols 
    task: filter_df_cols 
    partial: 
      columns: 
        - dist_meters
        - speed_bins_colormap
        - geometry
        - speed_kmhr
        - speed_bins
      df: ${{ workflow.apply_speed_colormap.return }}  

  - name: Generate speedmap layers 
    id: generate_speedmap_layers 
    task: create_path_layer 
    partial: 
      layer_style:
        get_color: speed_bins_colormap
        get_width: 2.85
        width_scale: 1 
        width_min_pixels: 2 
        width_max_pixels: 8 
        width_units: pixels
        cap_rounded: true 
        joint_rounded: true
        billboard: false
        opacity: 0.55
        stroked: true 
      legend:
        title: Speed (km/h)
        label_column: speed_bins
        color_column: speed_bins_colormap
        sort: ascending 
        label_suffix: null
      geodataframe: ${{ workflow.filter_speed_cols.return }}

  - name: Zoom to gdf extent 
    id: zoom_speed_gdf_extent
    task: view_state_deck_gdf
    partial: 
      pitch: 0
      bearing: 0
      gdf: ${{ workflow.filter_speed_cols.return }}
    
  - name: Combine ldx layers and speedmap layers 
    id: combined_ldx_speed_layers 
    task: combine_deckgl_map_layers
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      static_layers: 
        - ${{ workflow.create_ldx_styled_layers.return }}
      grouped_layers: ${{ workflow.generate_speedmap_layers.return }}

  - name: Draw speedmap 
    id: draw_speedmap
    task: draw_map 
    partial: 
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null 
      max_zoom: 10
      legend_style: 
        placement: bottom-right
      geo_layers: ${{ workflow.combined_ldx_speed_layers.return }}
      view_state: ${{ workflow.zoom_speed_gdf_extent.return }} 

  - name: Persist speedmap html 
    id: persist_speedmap_html
    task: persist_text 
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: speedmap 
      text : ${{ workflow.draw_speedmap.return }}

# generate sitrep report -- persist df 
  - name: Get sitrep config 
    id: get_sitrep_config 
    task: get_sitrep_event_config
    partial: 
      region_column: region 
  
  - name: Generate sitrep report 
    id: generate_sitrep_df
    task: compile_sitrep 
    partial:  
      er_io: ${{ workflow.er_client_name.return }}
      event_details: ${{ workflow.get_sitrep_config.return }}
      time_range: ${{ workflow.time_range.return }}
  
  - name: Persist sitrep as csv
    id: persist_livestock_events_gpkg
    task: persist_df 
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filetype: csv
      filename: sitrep_report
      df: ${{ workflow.generate_sitrep_df.return }}

  - name: MEP monthly report  dashboard
    id: mep_monthly_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets: []
      time_range: ${{ workflow.time_range.return}}
      groupers: ${{ workflow.groupers.return }}
      
