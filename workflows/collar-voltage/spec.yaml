id: collar_voltage
requirements:
  - name: ecoscope-workflows-core
    version: "0.3.7.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/
  - name: ecoscope-workflows-ext-ecoscope
    version: "0.3.7.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/
  - name: ecoscope-workflows-ext-mep
    version: "0.0.2.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

workflow:
  - name: Set Workflow Details
    id: workflow_details
    task: set_workflow_details

  - name: Data Source
    id: er_client_name
    task: set_er_connection

  - name: Time Range
    id: time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S %Z"

  - name: Filter Time Range
    id: filter_time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S %Z"

  - name: Get Subject Group Observations from EarthRanger
    id: subject_obs
    task: get_subjectgroup_observations
    partial:
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      raise_on_empty: true
      include_details: true
      include_subjectsource_details: true

  - name: Set Groupers
    id: groupers
    task: set_groupers

  - name: Split Observations by Group
    id: split_obs_groups
    task: split_groups
    partial:
      df: ${{ workflow.subject_obs.return }}
      groupers: ${{ workflow.groupers.return }}

  - name: Generate Collar Voltage Plot
    id: collar_voltage_plot
    task: calculate_collar_voltage
    partial:
      time_range: ${{ workflow.filter_time_range.return }}
    mapvalues:
      argnames: relocs
      argvalues: ${{workflow.split_obs_groups.return}}
  - name: Persist Voltage Chart as Text
    id: persist_voltage
    task: persist_text
    partial:
      root_path:  ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.collar_voltage_plot.return }}
  - name: Create Voltage Widget
    id: voltage_chart_widget
    task: create_plot_widget_single_view
    partial:
      title: "Collar Voltage"
    map:
      argnames: [view, data]
      argvalues: ${{ workflow.persist_voltage.return }}
  - name: Merge Voltage Widget Views
    id: grouped_voltage_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.voltage_chart_widget.return }}
  - name: Create a Dashboard
    id: voltage_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets:
        - ${{ workflow.grouped_voltage_widget.return }}
      time_range: ${{ workflow.time_range.return}}
      groupers: ${{ workflow.groupers.return }}

      