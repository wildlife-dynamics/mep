id: collared_elephant_report
requirements:
  - name: ecoscope-workflows-core
    version: "0.7.8.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/
  
  - name: ecoscope-workflows-ext-custom
    version: "0.0.3.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

  - name: ecoscope-workflows-ext-ecoscope
    version: "0.7.8.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/
    
  - name: ecoscope-workflows-ext-mep
    version: "*"
    channel: file:///tmp/ecoscope-workflows-custom/release/artifacts/

workflow:
# set workflow details
  - name: Set Workflow Details
    id: workflow_details
    task: set_workflow_details

# connect to GEE
  - name: Set Google Earth Engine Data Source
    id: gee_client
    task: set_gee_connection

# connect to ER 
  - name: Connect to Earth Ranger instance
    id: er_client
    task: set_er_connection

# configure base map layers
  - name: Configure Base Map Layers
    id: configure_base_maps
    task: set_base_maps
  
# set groupers
  - name: Configure grouping strategy
    id: configure_grouping_strategy
    task: set_groupers

# define time range
  - name: Define time range
    id: define_time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S %Z"
      
# download and extract landDx db
  - name: Retrieve and unpack landDX db 
    id: retrieve_ldx_db
    task: download_file_and_persist 
    partial:
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      url: "https://maraelephant.maps.arcgis.com/sharing/rest/content/items/6da0c9bdd43d4dd0ac59a4f3cd73dcab/data"
      unzip: true 

  # download logo and report templates
  - name: Download Logo 
    id: download_logo
    task: download_file_and_persist
    partial:
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false
      
  - name: Download template one
    id: download_template_one
    task: download_file_and_persist
    partial:
      url: https://www.dropbox.com/scl/fi/6yruu5uyino3gmzasdfy0/template_1.html?rlkey=w7haw2q8hkpv1ocsms0zq92rw&st=7bak4xbj&dl=0
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false

  - name: Download template two
    id: download_template_two
    task: download_file_and_persist
    partial:
      url: https://www.dropbox.com/scl/fi/6skjcsspv9rf5jgsyedgt/template_2.html?rlkey=lk73uq9m506ve9qsmghkk57k2&st=6lbck9k3&dl=0
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false

  - name: Download template three
    id: download_template_three
    task: download_file_and_persist
    partial:
      url: https://www.dropbox.com/scl/fi/44yv82b85lws8u657nuoy/template_3.html?rlkey=b0bdy09kb2oom13rvmd6r3gbc&st=550bazn1&dl=0
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false
  
  - name: Load AOI from landDX
    id: load_aoi
    task: load_landdx_aoi 
    partial:
      map_path: ${{ workflow.retrieve_ldx_db.return }}
  
  - name: split landDX layers by type
    id: split_landdx_by_type
    task: split_gdf_by_column
    partial: 
      gdf: ${{ workflow.load_aoi.return }}
      column: type
  
  - name: Annotate geometry types 
    id: annotate_geom_types
    task: annotate_gdf_dict_with_geometry_type
    partial:
      gdf_dict: ${{ workflow.split_landdx_by_type.return }}
  
  - name: Style landDX map layers
    id: create_styled_ldx_layers
    task: create_map_layers_from_annotated_dict
    partial:
      annotated_dict: ${{ workflow.annotate_geom_types.return }}

  # Get subjects dataframe
  - name: Get subject dataframe 
    id: subject_df
    task: get_subjects_info #custom task
    partial:
      client: ${{ workflow.er_client.return }}
      include_inactive: True 
  
  - name: Normalize additional subject info
    id: normalize_subject_info
    task: normalize_column
    partial:
      column: additional
      df: ${{ workflow.subject_df.return }}

  - name: Rename subject columns 
    id: rename_subject_cols
    task: map_columns
    partial:
      drop_columns:
        - url
        - image_url
        - common_name
        - content_type
        - additional__external_id	
        - additional__tm_animal_id
        - additional__external_name

      retain_columns:
        - id
        - name
        - hex
        - additional__rgb
        - additional__sex
        - additional__Bio
        - additional__DOB
        - additional__notes
        - additional__status
        - additional__region
        - additional__country
        - additional__id_photo
        - additional__distribution

      rename_columns:
        id: groupby_col
        name: subject_name
        hex: hex_color
        additional__rgb: rgb
        additional__Bio: subject_bio
        additional__sex: subject_sex
        additional__DOB: date_of_birth
        additional__notes: notes
        additional__status: status
        additional__region: region
        additional__country: country
        additional__id_photo: photo
        additional__distribution: distribution 

      df: ${{ workflow.normalize_subject_info.return }}

  # Retrieve subject observations
  - name: Get subject group observations from ER 
    id: subject_observations
    task: get_subjectgroup_observations
    partial:
      client: ${{ workflow.er_client.return }}
      time_range: ${{ workflow.define_time_range.return }}
      raise_on_empty: false
      include_details: false
      include_subjectsource_details: false
  
  - name: Transform observations to relocations 
    id: subject_relocations
    task: process_relocations 
    partial:
      observations: ${{ workflow.subject_observations.return }}
      relocs_columns:
        - fixtime
        - geometry
        - groupby_col
        - junk_status
        - extra__created_at
        - extra__subject__sex
        - extra__subject__hex
        - extra__subject__name
        - extra__subject__subject_subtype

      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  - name: View dataframe
    id: inspect_relocations_df
    task: view_df
    partial:
      gdf: ${{ workflow.subject_relocations.return }}
      name: Relocs

  # rename reloc columns 
  - name: Rename reloc columns 
    id: rename_reloc_cols
    task: map_columns
    partial:
      drop_columns: []
      retain_columns: []
      rename_columns:
        name: subject_name
        hex: hex_color
        sex: subject_sex
        subject_subtype: subject_subtype
        created_at: created_at
        # extra__subject__name: subject_name
        # extra__subject__hex: hex_color
        # extra__subject__sex: subject_sex
        # extra__subject__subject_subtype: subject_subtype
        # extra__created_at: created_at
        
      df: ${{ workflow.subject_relocations.return }}

# Compute maturity (default: 6 months)
  - name: Compute subject maturity
    id: compute_subject_maturity
    task: compute_maturity
    partial:
      subject_df: ${{ workflow.rename_subject_cols.return }}
      relocations_gdf: ${{ workflow.rename_reloc_cols.return }}
      months_duration: 6
  
  # Split subject df by group
  - name: split subjects df by group
    id: split_subject_by_group # use subject_name
    task: split_groups
    partial:
      df: ${{ workflow.compute_subject_maturity.return }}
      groupers: ${{ workflow.configure_grouping_strategy.return }}
  
  # 1. Download subject picture
  - name: Download subject profile photo
    id: download_profile_pic
    task: download_profile_photo
    partial:
      image_type: ".png"
      column: photo #additional__id_photo
      overwrite_existing: true
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }} 
    mapvalues:
      argnames: subject_df
      argvalues: ${{ workflow.split_subject_by_group.return }}

  # 2. Download subject info and persist
  - name: Download subject information
    id: download_subject_info
    task: generate_subject_info
    partial:
      maxlen: 1000
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }} 
    mapvalues:
      argnames: subject_df
      argvalues: ${{ workflow.split_subject_by_group.return }}

  - name: Persist subject information 
    id: persist_subject_info
    task: persist_df
    partial: 
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.download_subject_info.return }}

  # Retrieve events from ER
  - name : Retrieve events from ER
    id: get_events_data
    task: get_events
    partial:
      client: ${{ workflow.er_client.return }}
      time_range: ${{ workflow.define_time_range.return }}
      include_details: true
      raise_on_empty: true
      event_columns: 
        - id 
        - time 
        - event_type
        - event_category
        - reported_by
        - serial_number
        - geometry
        - event_details

  - name: Normalize event details 
    id: normalize_event_details
    task: normalize_column
    partial:
      column: event_details
      df: ${{ workflow.get_events_data.return }}

  - name: Rename event columns 
    id: rename_event_cols
    task: map_columns
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped

    partial:
      drop_columns: []
      retain_columns: []
      rename_columns:
        event_details__pic: pic
        event_details__region: region
        event_details__source: source
        event_details__details: details
        event_details__subject: groupby_col
        event_details__source_id: source_id
        event_details__subject_id: subject_name
        event_details__collaring_type: collaring_type
        event_details__collaring_reason: collaring_reason
        event_details__collar_checked_by: collar_checked_by
      df: ${{ workflow.normalize_event_details.return }}

  # Split events by set groupers
  - name: split events by group
    id: split_events_by_group # subject_name 
    task: split_groups
    partial:
      df: ${{ workflow.rename_event_cols.return }}
      groupers: ${{ workflow.configure_grouping_strategy.return }}
    
  # Split the relocations by group
  - name: Split relocations by group
    id: split_relocs_by_group
    task: split_groups
    partial:
      df: ${{ workflow.rename_reloc_cols.return }}
      groupers: ${{ workflow.configure_grouping_strategy.return }}

  # Convert relocations to trajectories
  - name: Convert relocations to trajectories
    id: convert_to_trajectories
    task: relocations_to_trajectory
    partial:
      relocations: ${{ workflow.rename_reloc_cols.return }}
  
  # Add temporal index to subject trajectories using segment_start
  - name: Add temporal index to trajectories
    id: add_temporal_index_to_traj
    task: add_temporal_index
    partial:
      df: ${{ workflow.convert_to_trajectories.return }}
      time_col: segment_start
      groupers: ${{ workflow.configure_grouping_strategy.return }}
      cast_to_datetime: true
      format: mixed 

  # classify trajectories into speed bins 
  - name: Classify trajectories by speed
    id: classify_trajectory_speed_bins
    task: apply_classification
    partial:
      df: ${{ workflow.add_temporal_index_to_traj.return }}
      input_column_name: speed_kmhr
      output_column_name: speed_bins
      classification_options:
        scheme: equal_interval
        k: 6
      label_options:
        label_ranges: false
        label_decimals: 1

  # rename trajectory columns
  - name: Rename trajectory columns 
    id: rename_trajectory_cols
    task: map_columns
    partial:
      drop_columns: []
      retain_columns: []
      rename_columns:
        extra__subject_name: subject_name
        extra__hex_color: hex_color
        extra__subject_sex: subject_sex
        extra__subject_subtype: subject_subtype

      df: ${{ workflow.classify_trajectory_speed_bins.return }}

  # Ecomaps
  # 1. Speedmap
  - name: Split trajectories by group
    id: split_trajs_by_group
    task: split_groups 
    partial:
      df: ${{ workflow.rename_trajectory_cols.return }}
      groupers: ${{ workflow.configure_grouping_strategy.return }}

  - name: Sort trajectories by speed bins
    id: sort_trajs_by_speed
    task: sort_values
    partial:
      column_name: speed_bins
      na_position: last
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.split_trajs_by_group.return }}

  - name: Apply colormap to speedbins 
    id: apply_speed_colormap
    task: apply_color_map
    partial:
      input_column_name: speed_bins
      output_column_name: speed_bins_colormap
      colormap:
        - '#1a9850'
        - '#91cf60'
        - '#d9ef8b'
        - '#fee08b'
        - '#fc8d59'
        - '#d73027'
    mapvalues:
      argnames: df 
      argvalues: ${{ workflow.sort_trajs_by_speed.return }}
  
  - name: Format speed bins for legend 
    id: format_speed_bin_labels
    task: map_values_with_unit
    partial:
      input_column_name: speed_bins
      output_column_name: speed_bins_formatted
      original_unit: km/h
      new_unit: km/h 
      decimal_places: 1
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.apply_speed_colormap.return }}
  
  - name: Format speed values for display
    id: format_speed_values
    task: map_values_with_unit
    partial:
      input_column_name: speed_kmhr
      output_column_name: speed_kmhr
      original_unit: km/h
      new_unit: km/h 
      decimal_places: 1
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.format_speed_bin_labels.return }}
  
  - name: Generata speedmap layers
    id: generate_speedmap_layers
    task: create_polyline_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        color_column: speed_bins_colormap
      legend:
        label_column: speed_bins_formatted
        color_column: speed_bins_colormap
      tooltip_columns:
        - subject_name
        - subject_sex
        - subject_subtype
        - speed_kmhr
        - speed_bins
        - dist_meters

    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.format_speed_values.return }}

  - name: Zoom speed trajectories by view state
    id: zoom_traj_view
    task: create_view_state_from_gdf
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.format_speed_values.return }}

  # combine static LandDx layers with speed ecomap trajectory layers
  - name: Combine landdx and speedmap layers
    id: combine_landdx_speed_layers
    task: combine_map_layers
    partial:
      static_layers: ${{ workflow.create_styled_ldx_layers.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.generate_speedmap_layers.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip speed layers and zoom values
    id: speedvalues_view_zip
    task: zip_grouped_by_key
    partial:
      left:  ${{ workflow.combine_landdx_speed_layers.return }}
      right: ${{ workflow.zoom_traj_view.return }}

  # draw speed ecomaps for each trajectory group
  - name: Draw Speedmap
    id: draw_speedmap
    task: draw_ecomap
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: Speed Values(Km/h)
      static: false
      title: null
      max_zoom: 20
    mapvalues:
      argnames: 
        - geo_layers
        - view_state
      argvalues: ${{ workflow.speedvalues_view_zip.return }}

  # persist HTML URLs of speed ecomaps as text files
  - name: Persist Speed Ecomap HTML Paths
    id: persist_speed_ecomap_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.draw_speedmap.return }}

  # create single-view map widgets for speed trajectory ecomaps
  - name: Create Speed Ecomap Widgets
    id: create_speed_ecomap_widgets
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: Speedmap
    map:
      argnames:
        - view 
        - data
      argvalues: ${{ workflow.persist_speed_ecomap_urls.return }}

  # merge individual speed ecomap widgets into a grouped view
  - name: Merge Speed Ecomap Widgets
    id: merge_speed_ecomap_widgets
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.create_speed_ecomap_widgets.return }}

  # 2. Home Range -ETD
  # generate elliptical time density (ETD) home range maps per subject group
  - name: Generate home range ecomap
    id: generate_etd
    task: calculate_elliptical_time_density
    partial:
      crs: ESRI:53042
      percentiles:
        - 50.0
        - 60.0
        - 70.0
        - 80.0
        - 90.0
        - 95.0
        - 99.9
      nodata_value: nan
      band_count: 1

    mapvalues:
      argnames: trajectory_gdf
      argvalues: ${{ workflow.split_trajs_by_group.return }}

  - name: Determine Seasonal Windows
    id: determine_seasonal_windows
    task: determine_season_windows
    partial:
      client: ${{ workflow.gee_client.return }}
      time_range: ${{ workflow.define_time_range.return }}
    mapvalues:
      argnames: roi
      argvalues: ${{ workflow.generate_etd.return }}
    
  - name: Zip ETD and grouped trajs
    id: zip_etd_and_grouped_trajs
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.determine_seasonal_windows.return }}
      right: ${{ workflow.split_trajs_by_group.return }}

  - name: Generate seasonal labels
    id: add_season_labels
    task: create_seasonal_labels
    mapvalues: 
      argnames: 
        - total_percentiles
        - traj 
      argvalues: ${{ workflow.zip_etd_and_grouped_trajs.return }}

  - name: Generate MCP gdf 
    id: calculate_mcp
    task: generate_mcp_gdf
    partial:
      planar_crs: ESRI:53042
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.split_trajs_by_group.return }}

  # apply colormap to ETD home range percentiles
  - name: Apply colormap to etd percentiles
    id: apply_etd_percentile_colormap
    task: apply_color_map
    partial:
      input_column_name: percentile
      colormap: RdYlGn
      output_column_name: percentile_colormap
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.generate_etd.return }}

  # create polygon map layers from ETD (home range) percentiles
  - name: Create hr etd layers
    id: generate_etd_ecomap_layers
    task: create_polygon_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        fill_color_column: percentile_colormap
        opacity: 0.55
      legend:
        label_column: percentile
        color_column: percentile_colormap
      tooltip_columns:
        - percentile
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.apply_etd_percentile_colormap.return }}

  - name: Zoom hr movement by view state
    id: zoom_hr_view
    task: create_view_state_from_gdf
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.apply_etd_percentile_colormap.return }}

  # combine static LandDx layers with home range (ETD) ecomap layers
  - name: Combine ldx and hr layers
    id: combine_landdx_hr_ecomap_layers
    task: combine_map_layers
    partial:
      static_layers: ${{ workflow.create_styled_ldx_layers.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.generate_etd_ecomap_layers.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip hr layers and zoom values
    id: hr_view_zip
    task: zip_grouped_by_key
    partial:
      left:  ${{ workflow.combine_landdx_hr_ecomap_layers.return }}
      right: ${{ workflow.zoom_hr_view.return }}

  # draw home range (ETD) ecomaps for each subject group
  - name: Draw Home Range Ecomaps by Group
    id: draw_hr_ecomaps
    task: draw_ecomap
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: Home Range Metrics
      static: false
      title: null
      max_zoom: 20
    mapvalues:
      argnames: 
        - geo_layers
        - view_state
      argvalues: ${{ workflow.hr_view_zip.return }}

  # persist HTML URLs of home range ecomaps as text files
  - name: Persist hr ecomap html urls
    id: persist_hr_ecomap_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text 
      argvalues: ${{ workflow.draw_hr_ecomaps.return }}

  # create single-view map widgets for home range ecomaps
  - name: Create hr ecomap widgets
    id: create_hr_ecomap_widgets
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: Home Range Ecomap
    map:
      argnames:
        - view 
        - data
      argvalues: ${{ workflow.persist_hr_ecomap_urls.return }}

  # merge home range ecomap widgets into a grouped view
  - name: Merge hr ecomap widgets
    id: merge_hr_ecomap_widgets
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.create_hr_ecomap_widgets.return }}

  # 3. Seasons
  - name: Calculate seasonal home range
    id: seasonal_home_range
    task: calculate_seasonal_home_range
    skipif:
      conditions:
        - any_is_empty_df
        - all_geometry_are_none
        - any_dependency_skipped
    partial:
      groupby_cols:
        - subject_name
        - season
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.add_season_labels.return }}

  - name: time density colormap
    id: season_colormap
    task: apply_color_map
    partial:
      input_column_name: season
      output_column_name: season_colormap
      colormap: 
        - '#f57c00' 
        - '#4cf3f7' 
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.seasonal_home_range.return }}

  - name: Create season layers
    id: season_etd_map_layer
    task: create_polygon_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        fill_color_column: season_colormap
        opacity: 0.650000
      
      legend:
        label_column:  season
        color_column: season_colormap
      
      tooltip_columns:
        - percentile
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.season_colormap.return }}
  
  # create polygon map layers for MCP
  - name: Create MCP Polygon Layer 
    id: generate_mcp_layers
    task: create_polygon_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        get_fill_color: '#FFFFFF00'
        get_line_color: '#dc143c'
        opacity: 0.55
        stroked: true
      legend:
        labels: 
          - mcp
        colors: 
          - '#dc143c'
      tooltip_columns:
        - area_km2
      
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.calculate_mcp.return }}

  # zip layers to include both hr and mcp 
  - name: zip mcp and season hr
    id: zip_season_mcp_hr
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.generate_mcp_layers.return }}
      right: ${{ workflow.season_etd_map_layer.return }}

  - name: Zoom seasons by view state
    id: zoom_season_view
    task: create_view_state_from_gdf
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.season_colormap.return }}

  - name: Combine map layers
    id: comb_season_map_layers
    task: combine_map_layers
    partial:
      static_layers: ${{ workflow.create_styled_ldx_layers.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.zip_season_mcp_hr.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip seasons layers and zoom values
    id: seasons_view_zip
    task: zip_grouped_by_key
    partial:
      left:  ${{ workflow.comb_season_map_layers.return }}
      right: ${{ workflow.zoom_season_view.return }}

  - name: Draw Season Ecomap 
    id: seasonal_ecomap
    task: draw_ecomap
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: Seasons
      static: false
      title: null
      max_zoom: 20
    
    mapvalues:
      argnames: 
         - geo_layers
         - view_state
      argvalues: ${{ workflow.seasons_view_zip.return }}

  - name: Perist HR ecomap as text
    id: season_etd_ecomap_html_url
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}

    mapvalues:
      argnames: text 
      argvalues: ${{ workflow.seasonal_ecomap.return }}

  - name: Create Map Widgets for seasons
    id: season_etd_widgets_single_view
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: Subject Group Home Range Map (Seasons)
    map:
      argnames:
        - view 
        - data
      
      argvalues: ${{ workflow.season_etd_ecomap_html_url.return }}

  - name: Merge Ecomap Widgets 
    id: season_grouped_map_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.season_etd_widgets_single_view.return }}

  - name: Persist seasonal windows as csv 
    id: persist_subject_season_wins
    task: persist_df
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.determine_seasonal_windows.return }}

  - name: Zip gdf and seasonal windows
    id: zip_nsd_values
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.split_relocs_by_group.return }}
      right: ${{ workflow.persist_subject_season_wins.return }}

  # Generate plots from events
  # 1. Generate seasonal NSD plot
  - name: Generate seasonal nsd plot
    id: generate_nsd_plot
    task: generate_seasonal_nsd_plot
    mapvalues:
      argnames:
        - relocations_gdf
        - seasons_df
      argvalues:
        - ${{ workflow.zip_nsd_values.return }}

  - name: Persist seasonal nsd plots
    id: persist_nsd_html_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.generate_nsd_plot.return }}
  
  - name: Create widget for nsd plot
    id: nsd_plot_widgets_single_view
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: Net Square Displacement (NSD)
    map:
      argnames:
        - view 
        - data
      
      argvalues: ${{ workflow.persist_nsd_html_urls.return }}

  - name: Merge nsd plot widgets 
    id: grouped_nsd_plot_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.nsd_plot_widgets_single_view.return }}

  # 2. Speed plot
  - name: zip gdf and seasonal windows for speed_plot
    id: zip_speed_values
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.split_relocs_by_group.return }}
      right: ${{ workflow.persist_subject_season_wins.return }}
  
  - name: Generate seasonal speed plot
    id: generate_speed_plot
    task: generate_seasonal_speed_plot
    mapvalues:
      argnames:
        - relocations_gdf
        - seasons_df
      argvalues:
        - ${{ workflow.zip_speed_values.return }}

  - name: Persist seasonal speed plots
    id: persist_speed_html_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.generate_speed_plot.return }}

  - name: Create widget for speed plot
    id: speed_plot_widgets_single_view
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: Speed
    map:
      argnames:
        - view 
        - data
      
      argvalues: ${{ workflow.persist_speed_html_urls.return }}

  - name: Merge speed plot widgets 
    id: grouped_speed_plot_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.speed_plot_widgets_single_view.return }}

  # 3. Collared Event plot
  - name: Zip gdf for collared subject plot
    id: zip_collared_subject_values
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.split_relocs_by_group.return }}
      right: ${{ workflow.persist_subject_season_wins.return }}

  - name: Generate collared subject plot
    id: generate_colared_subject_plot
    task: generate_collared_seasonal_plot
    partial:
      events_gdf: ${{ workflow.rename_event_cols.return }}
      filter_col: subject_name
    mapvalues:
      argnames:
        - relocations_gdf
        - seasons_df
      argvalues: ${{ workflow.zip_collared_subject_values.return }}
  
  - name: Persist collared subject plots
    id: persist_collared_subject_plots
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.generate_colared_subject_plot.return }}

  - name: Create widget for collared subject plot
    id: collared_widget_view
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: Collared Subject Plot
    map:
      argnames:
        - view 
        - data
      argvalues: ${{ workflow.persist_collared_subject_plots.return }}

  - name: Merge collared plot widgets 
    id: grouped_collared_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.collared_widget_view.return }}

  #4. MCP Asymptote plot
  - name: Zip gdf for mcp asymptote plot
    id: zip_mcp_asymp_values
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.split_relocs_by_group.return }}
      right: ${{ workflow.persist_subject_season_wins.return }}   

  - name: Generate mcp asymptote plot
    id: generate_mcp_asymp_plot   
    task: generate_seasonal_mcp_asymptote_plot
    mapvalues:
      argnames:
        - relocations_gdf
        - seasons_df
      argvalues:  
        - ${{ workflow.zip_mcp_asymp_values.return }}

  - name: Persist mcp asymptote plots
    id: persist_mcp_html_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.generate_mcp_asymp_plot.return }}
  
  - name: Create widget for mcp plot
    id: mcp_plot_widgets_single_view
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: MCP Asymptote
    map:
      argnames:
        - view 
        - data
      
      argvalues: ${{ workflow.persist_mcp_html_urls.return }}

  - name: Merge mcp plot widgets 
    id: grouped_mcp_plot_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.mcp_plot_widgets_single_view.return }}

  # Generate subject stats
  - name: Zip traj gdf and etd gdf
    id: zip_traj_etd_gdf
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.generate_etd.return }}
      right: ${{ workflow.split_trajs_by_group.return }}   

  - name: Generate subject stats
    id: generate_subject_stats
    task: get_subject_stats
    partial:
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      subject_df: ${{ workflow.compute_subject_maturity.return }}
      groupby_col: subject_name
    mapvalues:
      argnames: 
        - etd_df
        - traj_gdf
      argvalues: ${{ workflow.zip_traj_etd_gdf.return }}
  
  - name: Persist subject stats as csv
    id: persist_subject_stats
    task: persist_df
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.generate_subject_stats.return }}

  # Calculate subject occupancy 
  - name: Load Unfiltered Landdx 
    id: load_unfiltered_ldx
    task: load_landdx_aoi 
    partial:
      map_path: ${{ workflow.retrieve_ldx_db.return }}

  - name: Zip etd gdf and subject df
    id: zip_etd_subjects
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.generate_etd.return }}
      right: ${{ workflow.split_subject_by_group.return }}

  - name: Build regional lookup from landDx db
    id: build_region_lookup
    task: build_template_region_lookup
    partial:
      gdf: ${{ workflow.load_unfiltered_ldx.return }}
  
  - name: Compute template regions
    id: comp_template_regions
    task: compute_template_regions
    partial:
      geodataframe: ${{ workflow.load_unfiltered_ldx.return }}
      template_lookup: ${{ workflow.build_region_lookup.return }}
      crs: ESRI:53042
  
  - name: Calculate subject occupancy
    id: process_subject_occupancy
    task: compute_subject_occupancy
    partial:
      crs: ESRI:53042
      regions_gdf: ${{ workflow.comp_template_regions.return }}
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: 
        - etd_gdf
        - subjects_df
      argvalues: ${{ workflow.zip_etd_subjects.return }}

  - name: persist subject occupancy as csv
    id: persist_subject_occupancy
    task: persist_df
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.process_subject_occupancy.return }}
    
  #convert all html to png 
  # 1. Ecomaps - Range , Speedmap, Season 
  - name: Convert range ecomap html to png 
    id: convt_range_html_png
    task: html_to_png
    partial:
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 100
        width: 765
        height: 525
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.persist_hr_ecomap_urls.return }}

  - name: Convert speedmap html to png 
    id: convt_speedmap_html_png
    task: html_to_png
    partial:
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 100
        width: 765
        height: 525
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.persist_speed_ecomap_urls.return }}

  - name: Convert seasons ecomap html to png 
    id: convt_seasons_html_png
    task: html_to_png
    partial:
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 100
        width: 602
        height: 855
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.season_etd_ecomap_html_url.return }}

  # 2. plots - nsd plot, speed plot,collar events plot , mcp asymptote plot 
  - name: Convert nsd plot html to png 
    id: convt_nsdp_html_png
    task: html_to_png
    partial:
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 100
        width: 2238
        height: 450
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.persist_nsd_html_urls.return }}
  
  - name: Convert mcp plot html to png 
    id: convt_mcp_html_png
    task: html_to_png
    partial:
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 100
        width: 2238
        height: 450
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.persist_mcp_html_urls.return }}

  - name: Convert speed plot html to png 
    id: convt_speedp_html_png
    task: html_to_png
    partial:
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 100
        width: 2238
        height: 450
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.persist_speed_html_urls.return }}

  - name: Convert collared events plot html to png 
    id: convt_colev_html_png
    task: html_to_png
    partial:
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 100
        width: 2238
        height: 450
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.persist_collared_subject_plots.return }}

  - name: Zip movement and range ecomaps
    id: zip_movement_range_maps
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.convt_speedmap_html_png.return }}
      right: ${{ workflow.convt_range_html_png.return }}
  
  - name: zip movement range and overview map
    id: zip_range_mov_overview
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_movement_range_maps.return }}
      right: ${{ workflow.convt_seasons_html_png.return }}
  
  - name: zip movement ,range ,overview maps and subject photo
    id: zip_range_subject_photo
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_range_mov_overview.return }}
      right: ${{ workflow.download_profile_pic.return }}
  
  - name: zip existing list with collared plot
    id: zip_items_w_collared
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_range_subject_photo.return }}
      right: ${{ workflow.convt_colev_html_png.return }}
  
  - name: zip existing with nsd plot
    id: zip_with_nsd
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_items_w_collared.return }}
      right: ${{ workflow.convt_nsdp_html_png.return }}
  
  - name: zip existing with speed plot 
    id: zip_with_speed
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_with_nsd.return }}
      right: ${{ workflow.convt_speedp_html_png.return }}
  
  - name: zip existing with mcp plot 
    id: zip_with_mcp
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_with_speed.return }}
      right: ${{ workflow.convt_mcp_html_png.return }}
  
  - name: zip existing with subject info
    id: zip_subject_info
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_with_mcp.return }}
      right: ${{ workflow.persist_subject_info.return}}
  
  - name: zip existing with subject stats
    id: zip_subject_stats
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_subject_info.return }}
      right: ${{ workflow.persist_subject_stats.return }}
  
  - name: zip existing with occupancy info
    id: zip_occupancy_info
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_subject_stats.return }}
      right: ${{ workflow.persist_subject_occupancy.return }}

  - name: Flatten zipped collared report context inputs
    id: flatten_collared_context
    task: flatten_tuple
    mapvalues:
      argnames: nested
      argvalues: ${{ workflow.zip_occupancy_info.return }}

  - name: View flatten info outputs 
    id: view_flatten_data
    task: print_output
    partial:
      value: ${{ workflow.flatten_collared_context.return  }}

  - name: Generate report context
    id: generate_report_context
    task: report_context
    partial:
      subjects_df: ${{ workflow.compute_subject_maturity.return }}
      templates:
        - ${{ workflow.download_template_one.return }}
        - ${{ workflow.download_template_two.return }}
        - ${{ workflow.download_template_three.return }}
      input_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      logo: ${{ workflow.download_logo.return }}
    
    mapvalues:
      argnames:
        - movement_ecomap
        - range_ecomap 
        - overview_ecomap
        - subject_photo
        - collar_event_timeline_plot 
        - nsd_plot
        - speed_plot
        - mcp_plot
        - subject_info
        - subject_stats
        - occupancy_info
      argvalues: ${{ workflow.flatten_collared_context.return }}

  - name: Render html to pdf 
    id: render_html_pdf
    task: render_html_to_pdf
    partial:
      #html_path: ${{ workflow.generate_report_context.return }}
      pdf_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.generate_report_context.return }}

  - name: Merge pdfs
    id: merge_subject_pdf
    task: merge_pdfs
    partial:
      subject_df: ${{ workflow.compute_subject_maturity.return }}
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: Collared Elephants Report
      pdf_path_items: ${{ workflow.render_html_pdf.return }}
    # mapvalues:
    #   argnames: pdf_path_items
    #   argvalues: ${{ workflow.render_html_pdf.return }}
      
  # combine all these outputs and have them on the dashboard 
  - name: Collared Elephant Report Dashboard 
    id: collared_report_template 
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return }}
      widgets: 
        - ${{ workflow.merge_speed_ecomap_widgets.return }}
        - ${{ workflow.merge_hr_ecomap_widgets.return }}
        - ${{ workflow.season_grouped_map_widget.return }}
        - ${{ workflow.grouped_nsd_plot_widget.return }}
        - ${{ workflow.grouped_speed_plot_widget.return }}
        - ${{ workflow.grouped_collared_widget.return }}
        - ${{ workflow.grouped_mcp_plot_widget.return }}     

      time_range: ${{ workflow.define_time_range.return }}
      groupers: ${{ workflow.configure_grouping_strategy.return }}