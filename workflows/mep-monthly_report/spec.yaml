id: mep_monthly_report
requirements:
  - name: ecoscope-workflows-core
    version: "0.20.6.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-ecoscope
    version: "0.20.6.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-custom
    version: "0.0.23.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/
    
  - name: ecoscope-workflows-ext-ste
    version: "0.0.10.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

  - name: ecoscope-workflows-ext-mnc
    version: "0.0.2.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

  - name: ecoscope-workflows-ext-mep
    version: "*"
    channel: file:///tmp/ecoscope-workflows-custom/release/artifacts/

rjsf-overrides:
  properties: 
    Subject Group.properties.subject_group_var.properties.var.title: Subject Group Name
    Subject Group..properties.subject_group_var.properties.var.default: subject_name

  $defs:
    # Restrict category options to Subject Name only
    ValueGrouper.oneOf:
      - const: subject_name
        title: Subject Name

task-instance-defaults:
  skipif:
    conditions:
      - any_is_empty_df
      - any_dependency_skipped

workflow:
  # set workflow details 
  - name: Set workflow details
    id: workflow_details
    task: set_workflow_details

  # define time range 
  - name: Define analysis time range 
    id: time_range 
    task: set_time_range 
    
  # set groupers -- limiting this to subject_name
  - name: Configure grouping strategy 
    id: groupers 
    task: set_custom_groupers
    partial:
      groupers: []
  
  # set basemaps
  - name: Configure base map layers 
    id: configure_base_maps 
    task: set_base_maps_pydeck

  # connect to earthranger
  - name: Connect to earth ranger
    id: er_client_name
    task: set_er_connection 
  
  # connect to earthengine 
  - name: Connect to earth engine 
    id: gee_project_name
    task: set_gee_connection 
  
# get events -- elephant sighting and persist file 
  - name: Retrieve all events 
    id: get_events_data
    task: get_events
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      event_columns:
        - id
        - time
        - event_type
        - event_category
        - reported_by
        - serial_number
        - geometry
        - created_at
        - event_details
      event_types:
        - mep_elephant_sighting
      raise_on_empty: true
      include_details: true
      include_updates: false
      include_related_events: false
      include_null_geometry: false
      include_display_values: false

  - name: Exclude geom outliers from mep elephant sighting events
    id: exclude_mep_outliers
    task: exclude_geom_outliers
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial: 
      df: ${{ workflow.get_events_data.return }}
      z_threshold: 3

  - name: Remove elephant sightinginvalid points 
    id: remove_mep_invalid_geoms 
    task: ecoscope_workflows_ext_custom.tasks.transformation.drop_null_geometry
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial: 
      gdf: ${{ workflow.exclude_mep_outliers.return }}
      geometry_column: geometry 

  - name: Generate elephant sighting point layers
    id: generate_mb_layers
    task: create_scatterplot_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        get_fill_color: [85, 107, 47]
        get_radius: 5
        opacity: 0.75
        stroked: false
      legend:
        title: Elephant sightings 
        values: #556b2f
          - label: Sighting 
            color: "#556b2f"
      geodataframe: ${{ workflow.remove_mep_invalid_geoms.return }}
  
  # global zoom value 
  - name: Elephant sightings zoom value
    id: sighting_zoom_value
    task: view_state_deck_gdf
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      pitch: 0
      bearing: 0
      gdf: ${{ workflow.remove_mep_invalid_geoms.return }}

  - name: Draw elephant sightings map
    id: draw_sightings_map
    task: draw_map
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null
      max_zoom: 10
      legend_style:
        placement: "bottom-right"
      geo_layers: ${{ workflow.generate_mb_layers.return }}
      view_state: ${{ workflow.sighting_zoom_value.return }} 

  - name: Persist elephant sightings map
    id: persist_sightings_urls
    task: persist_text
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      text: ${{ workflow.draw_sightings_map.return }}
      filename: elephant_sightings_map.html  # -- convert this to png 

# get relocations  -- collar voltages for subjects and persist file
  - title: Subject Group
    type: task-group
    description: Choose subject group to generate collar voltage charts and overall speedmap
    tasks:
      - name: null
        id: subject_group_var
        task: set_string_var

  - name: Get subject group observations 
    id: subject_observations
    task: get_subjectgroup_observations
    partial: 
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      subject_group_name: ${{ workflow.subject_group_var.return }}
      raise_on_empty: false 
      include_details: true
      include_subjectsource_details: true

  - name: Transform observations to relocations 
    id: subject_reloc
    task: process_relocations 
    partial: 
      observations: ${{ workflow.subject_observations.return }}
      relocs_columns: 
        - groupby_col
        - fixtime
        - junk_status 
        - geometry
        - extra__subject__name
        - extra__subject__hex
        - extra__subject__sex
        - extra__created_at
        - extra__subject__subject_subtype
        - extra__subjectsource__id
        - extra__subjectsource__assigned_range
        - extra__observation_details

      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  - name: Create collared charts for all subjects 
    id: process_subject_charts 
    task: process_collar_voltage_charts 
    partial: 
      relocs: ${{ workflow.subject_observations.return }}
      time_range: ${{ workflow.time_range.return }}
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }} # convert outputs to png 
  
# relocs to trajectories -- speedmap and persist file 
  - name: Convert relocations to trajectories 
    id: convert_to_trajectories 
    task: relocations_to_trajectory 
    partial: 
      relocations: ${{ workflow.subject_reloc.return }}
      trajectory_segment_filter:
        min_length_meters: 0.001
        max_length_meters: 5000
        min_time_secs: 1
        max_time_secs: 21600
        min_speed_kmhr: 0.01
        max_speed_kmhr: 9

  - name: Add temporal index to trajectories 
    id: add_temporal_index_to_traj 
    task: add_temporal_index
    partial: 
      df: ${{ workflow.convert_to_trajectories.return }}
      time_col: segment_start 
      groupers: ${{ workflow.groupers.return }}
      cast_to_datetime: true 
      format: mixed 

  - name: Classify trajectories by speed 
    id: classify_trajectories_speed_bins 
    task: apply_classification 
    partial: 
      df: ${{ workflow.add_temporal_index_to_traj.return }}
      input_column_name: speed_kmhr
      output_column_name: speed_bins
      classification_options: 
        scheme: equal_interval 
        k: 6 
      label_options:
        label_ranges: true
        label_decimals: 1
        label_suffix: ' km/h'
  
  - name: Sort trajectories by speed bins 
    id: sort_trajs_by_speed 
    task: sort_values
    partial: 
      column_name: speed_bins 
      na_position: first 
      ascending: true 
      df: ${{ workflow.classify_trajectories_speed_bins.return }}

  - name: Apply colormap to speed bins 
    id: apply_speed_colormap 
    task: apply_color_map 
    partial: 
      input_column_name: speed_bins
      output_column_name: speed_bins_colormap 
      colormap: 
        - '#1a9850'
        - '#91cf60'
        - '#d9ef8b'
        - '#fee08b'
        - '#fc8d59'
        - '#d73027'
      df: ${{ workflow.sort_trajs_by_speed.return }}
      
  - name: Exclude unnecessary columns from speedmap gdf 
    id: filter_speed_cols 
    task: filter_df_cols 
    partial: 
      columns: 
        - dist_meters
        - speed_bins_colormap
        - geometry
        - speed_kmhr
        - speed_bins
      df: ${{ workflow.apply_speed_colormap.return }}  

  - name: Generate speedmap layers 
    id: generate_speedmap_layers 
    task: create_path_layer 
    partial: 
      layer_style:
        get_color: speed_bins_colormap
        get_width: 2.85
        width_scale: 1 
        width_min_pixels: 2 
        width_max_pixels: 8 
        width_units: pixels
        cap_rounded: true 
        joint_rounded: true
        billboard: false
        opacity: 0.55
        stroked: true 
      legend:
        title: Speed (km/h)
        label_column: speed_bins
        color_column: speed_bins_colormap
        sort: ascending 
        label_suffix: null
      geodataframe: ${{ workflow.filter_speed_cols.return }}

  - name: Zoom to gdf extent 
    id: zoom_speed_gdf_extent
    task: view_state_deck_gdf
    partial: 
      pitch: 0
      bearing: 0
      gdf: ${{ workflow.filter_speed_cols.return }}
    
  - name: Draw speedmap 
    id: draw_speedmap
    task: draw_map 
    partial: 
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null 
      max_zoom: 10
      legend_style: 
        placement: bottom-right
      geo_layers: ${{ workflow.generate_speedmap_layers.return }}
      view_state: ${{ workflow.zoom_speed_gdf_extent.return }} 

  - name: Persist speedmap html 
    id: persist_speedmap_html
    task: persist_text 
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: speedmap 
      text : ${{ workflow.draw_speedmap.return }}

# generate sitrep report -- persist df 
  - name: Get sitrep config 
    id: get_sitrep_config 
    task: get_sitrep_event_config
    partial: 
      region_column: region 
  
  - name: Generate sitrep report 
    id: generate_sitrep_df
    task: compile_sitrep 
    partial:  
      er_io: ${{ workflow.er_client_name.return }}
      event_details: ${{ workflow.get_sitrep_config.return }}
      time_range: ${{ workflow.time_range.return }}
  
  - name: Persist sitrep as csv
    id: persist_livestock_events_gpkg
    task: persist_df 
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filetype: csv
      filename: sitrep_report
      df: ${{ workflow.generate_sitrep_df.return }}

  - name: Retrieve vehicle patrols 
    id: vehicle_patrols 
    task: get_patrol_observations 
    partial: 
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      include_patrol_details: true 
      raise_on_empty: true
      sub_page_size: 100 
      patrol_types: 
      - "MEP_routine_vehicle_patrol_bravo_team"
      - "MEP_routine_vehicle_patrol_foxtrot_team"
      - "MEP_Routine_Vehicle_Patrol - Mwaluganje Team"
      - "MEP_routine_vehicle_patrol_hq_team"
      - "MEP_routine_vehicle_patrol_delta_team"
      - "MEP_routine_vehicle_patrol_echo_team"
      - "MEP_routine_vehicle_patrol_kilo_team"
      - "MEP_routine_vehicle_patrol_mobile_team"
      - "MEP_routine_vehicle_patrol_alpha_team"
      - "MEP_routine_vehicle_patrol_charlie_team"
      - "MEP_routine_vehicle_patrol_golf_team"

  - name: Transform observations to relocations 
    id: vehicle_patrol_reloc
    task: process_relocations
    partial: 
      observations: ${{ workflow.vehicle_patrols.return }}
      relocs_columns: 
        - patrol_id
        - patrol_start_time
        - patrol_end_time
        - geometry
        - patrol_type__value
        - patrol_type__display
        - patrol_serial_number
        - patrol_status
        - patrol_subject
        - groupby_col
        - fixtime
        - junk_status
        - extra__source

      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  - name: Transform relocations to trajectories 
    id: vehicle_patrol_traj 
    task: relocations_to_trajectory 
    partial: 
      relocations: ${{ workflow.vehicle_patrol_reloc.return }}
      trajectory_segment_filter:
        min_length_meters: 0.35
        max_length_meters: 5000.0
        max_time_secs: 18000.0
        min_time_secs: 1.0
        max_speed_kmhr: 100.0
        min_speed_kmhr: 10.0

  - name: Persist vehicle patrol trajectories 
    id: persist_vehicle_traj 
    task: persist_df 
    partial: 
      df: ${{ workflow.vehicle_patrol_traj.return }}
      filetype: geoparquet
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: vehicle_patrol_trajectories 

  - name: Vehicle patrol trajectories colormap 
    id: vehicle_traj_colormap 
    task: apply_color_map
    partial: 
      df: ${{ workflow.vehicle_patrol_traj.return }}
      colormap: viridis
      input_column_name: extra__patrol_type__value
      output_column_name: patrol_type_colormap 

  - name: Vehicle patrols zoom value
    id: vehicle_zoom_value
    task: view_state_deck_gdf
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      pitch: 0
      bearing: 0
      gdf: ${{ workflow.vehicle_traj_colormap.return }}

  - name: Create vehicle patrol layers 
    id: vehicle_patrol_path_layer 
    task: create_path_layer
    partial: 
      layer_style:
        get_color: patrol_type_colormap
        get_width: 2.85
        width_scale: 1 
        width_min_pixels: 2 
        width_max_pixels: 8 
        width_units: pixels
        cap_rounded: true 
        joint_rounded: true
        billboard: false
        opacity: 0.55
        stroked: true 
      legend:
        title: Patrol team
        label_column: extra__patrol_type__value
        color_column: patrol_type_colormap
        sort: ascending 
        label_suffix: null
      geodataframe: ${{ workflow.vehicle_traj_colormap.return }}

  - name: Draw vehicle patrols map
    id: draw_vehicles_map
    task: draw_map
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null
      max_zoom: 10
      legend_style:
        placement: "bottom-right"
      geo_layers: ${{ workflow.vehicle_patrol_path_layer.return }}
      view_state: ${{ workflow.vehicle_zoom_value.return }} 

  - name: Persist vehicle patrols as text 
    id: vehicle_patrol_map 
    task: persist_text
    partial:  
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: vehicle_patrols_map.html
      text: ${{ workflow.draw_vehicles_map.return }} # convert this to png 

  # foot patrols 
  - name: Retrieve foot patrols 
    id: foot_patrols 
    task: get_patrol_observations 
    partial: 
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      include_patrol_details: true 
      raise_on_empty: true
      sub_page_size: 100 
      patrol_types: 
        - "MEP_routine_foot_patrol_bravo_team"
        - "MEP_routine_foot_patrol_foxtrot_team"
        - "MEP_routine_foot_patrol_HQ_team"
        - "MEP_routine_foot_patrol_ Delta_Team"
        - "MEP_routine_foot_patrol_echo_team"
        - "MEP_routine_foot_patrol_kilo_team"
        - "mwaluganje_routine_foot_patrol_alpha_team"
        - "MEP_routine_foot_patrol_alpha_team"
        - "MEP_routine_foot_patrol_charlie_team"
        - "MEP_routine_foot_patrol_golf_team"
        - "MEP_routine_foot_patrol_marmanet"

  - name: Transform observations to relocations 
    id: foot_patrol_reloc
    task: process_relocations
    partial: 
      observations: ${{ workflow.foot_patrols.return }}
      relocs_columns: 
        - patrol_id
        - patrol_start_time
        - patrol_end_time
        - geometry
        - patrol_type__value
        - patrol_type__display
        - patrol_serial_number
        - patrol_status
        - patrol_subject
        - groupby_col
        - fixtime
        - junk_status
        - extra__source

      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  - name: Transform relocations to trajectories 
    id: foot_patrol_traj 
    task: relocations_to_trajectory 
    partial: 
      relocations: ${{ workflow.foot_patrol_reloc.return }}
      trajectory_segment_filter:
        min_length_meters: 0.001
        max_length_meters: 5000.0
        max_time_secs: 14400.0
        min_time_secs: 1.0
        max_speed_kmhr: 9.0
        min_speed_kmhr: 0.5

  - name: Persist foot patrol trajectories 
    id: persist_foot_traj 
    task: persist_df 
    partial: 
      df: ${{ workflow.foot_patrol_traj.return }}
      filetype: geoparquet
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: foot_patrol_trajectories 

  - name: Foot patrol trajectories colormap 
    id: foot_traj_colormap 
    task: apply_color_map
    partial: 
      df: ${{ workflow.foot_patrol_traj.return }}
      colormap: viridis
      input_column_name: extra__patrol_type__value
      output_column_name: patrol_type_colormap 

  - name: Foot patrols zoom value
    id: foot_zoom_value
    task: view_state_deck_gdf
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      pitch: 0
      bearing: 0
      gdf: ${{ workflow.foot_traj_colormap.return }}

  - name: Create foot patrol layers 
    id: foot_patrol_path_layer 
    task: create_path_layer
    partial: 
      layer_style:
        get_color: patrol_type_colormap
        get_width: 2.85
        width_scale: 1 
        width_min_pixels: 2 
        width_max_pixels: 8 
        width_units: pixels
        cap_rounded: true 
        joint_rounded: true
        billboard: false
        opacity: 0.55
        stroked: true 
      legend:
        title: Patrol team
        label_column: extra__patrol_type__value
        color_column: patrol_type_colormap
        sort: ascending 
        label_suffix: null
      geodataframe: ${{ workflow.foot_traj_colormap.return }}

  - name: Draw foot patrols map
    id: draw_foot_map
    task: draw_map
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null
      max_zoom: 10
      legend_style:
        placement: "bottom-right"
      geo_layers: ${{ workflow.foot_patrol_path_layer.return }}
      view_state: ${{ workflow.foot_zoom_value.return }} 

  - name: Persist foot patrols as text 
    id: foot_patrol_map 
    task: persist_text
    partial:  
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: foot_patrols_map.html
      text: ${{ workflow.draw_foot_map.return }} # convert this to png 


  # proceed to add the ndvi charts now 
  - name: Download ROI file and persist
    id: download_roi_file
    task: fetch_and_persist_file
    partial:
      url: https://www.dropbox.com/scl/fi/2bpktq45zns9igryl6q9l/ROIs.gpkg?rlkey=sojch2njmvsa3i5a3f3pt11xq&st=9x70z6z1&dl=0
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false 
      retries: 3 
      unzip: false

  - name: Load roi
    id: load_roi 
    task: load_df 
    partial: 
      file_path: ${{ workflow.download_roi_file.return }}
      layer: null 
      deserialize_json: false 
  
  - name: Transform gdf to epsg 4326
    id: transform_roi
    task: transform_gdf_crs 
    partial:
      gdf: ${{ workflow.load_roi.return }}
      crs: "EPSG:4326"

  - name: Process ndvi charts 
    id: process_ndvi_charts 
    task: process_aoi_ndvi_charts 
    partial: 
      df: ${{ workflow.transform_roi.return }}
      er_client: ${{ workflow.gee_project_name.return }}
      aoi_column: name 
      time_range: ${{ workflow.time_range.return }}
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}


  - name: MEP monthly report  dashboard
    id: mep_monthly_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return}}
      widgets: []
      time_range: ${{ workflow.time_range.return}}
      groupers: ${{ workflow.groupers.return }}
      
