# AUTOGENERATED BY ECOSCOPE-WORKFLOWS; see fingerprint in README.md for details

# ruff: noqa: E402

"""WARNING: This file is generated in a testing context and should not be used in production.
Lines specific to the testing context are marked with a test tube emoji (ðŸ§ª) to indicate
that they would not be included (or would be different) in the production version of this file.
"""

import json
import os
import warnings  # ðŸ§ª
from ecoscope_workflows_core.testing import create_task_magicmock  # ðŸ§ª


from ecoscope_workflows_core.graph import DependsOn, DependsOnSequence, Graph, Node

from ecoscope_workflows_core.tasks.config import set_workflow_details
from ecoscope_workflows_core.tasks.io import set_gee_connection
from ecoscope_workflows_core.tasks.io import set_er_connection
from ecoscope_workflows_ext_ecoscope.tasks.results import set_base_maps
from ecoscope_workflows_core.tasks.groupby import set_groupers
from ecoscope_workflows_core.tasks.filter import set_time_range
from ecoscope_workflows_ext_mep.tasks import download_file_and_persist
from ecoscope_workflows_ext_mep.tasks import load_landdx_aoi
from ecoscope_workflows_ext_mep.tasks import split_gdf_by_column
from ecoscope_workflows_ext_mep.tasks import annotate_gdf_dict_with_geometry_type
from ecoscope_workflows_ext_mep.tasks import create_map_layers_from_annotated_dict
from ecoscope_workflows_ext_mep.tasks import get_subjects_info
from ecoscope_workflows_ext_ecoscope.tasks.transformation import normalize_column
from ecoscope_workflows_core.tasks.transformation import map_columns

get_subjectgroup_observations = create_task_magicmock(  # ðŸ§ª
    anchor="ecoscope_workflows_ext_ecoscope.tasks.io",  # ðŸ§ª
    func_name="get_subjectgroup_observations",  # ðŸ§ª
)  # ðŸ§ª
from ecoscope_workflows_ext_ecoscope.tasks.preprocessing import process_relocations
from ecoscope_workflows_ext_mep.tasks import view_df
from ecoscope_workflows_ext_mep.tasks import compute_maturity
from ecoscope_workflows_core.tasks.groupby import split_groups
from ecoscope_workflows_ext_mep.tasks import download_profile_photo
from ecoscope_workflows_ext_mep.tasks import generate_subject_info
from ecoscope_workflows_ext_ecoscope.tasks.io import persist_df

get_events = create_task_magicmock(  # ðŸ§ª
    anchor="ecoscope_workflows_ext_ecoscope.tasks.io",  # ðŸ§ª
    func_name="get_events",  # ðŸ§ª
)  # ðŸ§ª
from ecoscope_workflows_core.tasks.skip import any_is_empty_df
from ecoscope_workflows_core.tasks.skip import any_dependency_skipped
from ecoscope_workflows_ext_ecoscope.tasks.preprocessing import (
    relocations_to_trajectory,
)
from ecoscope_workflows_core.tasks.transformation import add_temporal_index
from ecoscope_workflows_ext_ecoscope.tasks.transformation import apply_classification
from ecoscope_workflows_core.tasks.transformation import sort_values
from ecoscope_workflows_ext_ecoscope.tasks.transformation import apply_color_map
from ecoscope_workflows_core.tasks.transformation import map_values_with_unit
from ecoscope_workflows_ext_ecoscope.tasks.results import create_polyline_layer
from ecoscope_workflows_ext_mep.tasks import create_view_state_from_gdf
from ecoscope_workflows_ext_mep.tasks import combine_map_layers
from ecoscope_workflows_ext_mep.tasks import zip_grouped_by_key
from ecoscope_workflows_ext_ecoscope.tasks.results import draw_ecomap
from ecoscope_workflows_core.tasks.io import persist_text
from ecoscope_workflows_core.tasks.results import create_map_widget_single_view
from ecoscope_workflows_core.tasks.skip import never
from ecoscope_workflows_core.tasks.results import merge_widget_views
from ecoscope_workflows_ext_ecoscope.tasks.analysis import (
    calculate_elliptical_time_density,
)

determine_season_windows = create_task_magicmock(  # ðŸ§ª
    anchor="ecoscope_workflows_ext_ecoscope.tasks.io",  # ðŸ§ª
    func_name="determine_season_windows",  # ðŸ§ª
)  # ðŸ§ª
from ecoscope_workflows_ext_mep.tasks import create_seasonal_labels
from ecoscope_workflows_ext_mep.tasks import generate_mcp_gdf
from ecoscope_workflows_ext_ecoscope.tasks.results import create_polygon_layer
from ecoscope_workflows_ext_mep.tasks import calculate_seasonal_home_range
from ecoscope_workflows_ext_ecoscope.tasks.skip import all_geometry_are_none
from ecoscope_workflows_ext_mep.tasks import generate_seasonal_nsd_plot
from ecoscope_workflows_ext_mep.tasks import generate_seasonal_speed_plot
from ecoscope_workflows_ext_mep.tasks import generate_collared_seasonal_plot
from ecoscope_workflows_ext_mep.tasks import generate_seasonal_mcp_asymptote_plot
from ecoscope_workflows_ext_mep.tasks import get_subject_stats
from ecoscope_workflows_ext_mep.tasks import build_template_region_lookup
from ecoscope_workflows_ext_mep.tasks import compute_template_regions
from ecoscope_workflows_ext_mep.tasks import compute_subject_occupancy
from ecoscope_workflows_ext_custom.tasks import html_to_png
from ecoscope_workflows_ext_mep.tasks import flatten_tuple
from ecoscope_workflows_ext_mep.tasks import print_output
from ecoscope_workflows_ext_mep.tasks import report_context
from ecoscope_workflows_ext_mep.tasks import render_html_to_pdf
from ecoscope_workflows_ext_mep.tasks import merge_pdfs
from ecoscope_workflows_core.tasks.results import gather_dashboard

from ..params import Params


def main(params: Params):
    warnings.warn("This test script should not be used in production!")  # ðŸ§ª

    params_dict = json.loads(params.model_dump_json(exclude_unset=True))

    dependencies = {
        "workflow_details": [],
        "gee_client": [],
        "er_client": [],
        "configure_base_maps": [],
        "configure_grouping_strategy": [],
        "define_time_range": [],
        "retrieve_ldx_db": [],
        "download_logo": [],
        "download_template_one": [],
        "download_template_two": [],
        "download_template_three": [],
        "load_aoi": ["retrieve_ldx_db"],
        "split_landdx_by_type": ["load_aoi"],
        "annotate_geom_types": ["split_landdx_by_type"],
        "create_styled_ldx_layers": ["annotate_geom_types"],
        "subject_df": ["er_client"],
        "normalize_subject_info": ["subject_df"],
        "rename_subject_cols": ["normalize_subject_info"],
        "subject_observations": ["er_client", "define_time_range"],
        "subject_relocations": ["subject_observations"],
        "inspect_relocations_df": ["subject_relocations"],
        "rename_reloc_cols": ["subject_relocations"],
        "compute_subject_maturity": ["rename_subject_cols", "rename_reloc_cols"],
        "split_subject_by_group": [
            "compute_subject_maturity",
            "configure_grouping_strategy",
        ],
        "download_profile_pic": ["split_subject_by_group"],
        "download_subject_info": ["split_subject_by_group"],
        "persist_subject_info": ["download_subject_info"],
        "get_events_data": ["er_client", "define_time_range"],
        "normalize_event_details": ["get_events_data"],
        "rename_event_cols": ["normalize_event_details"],
        "split_events_by_group": ["rename_event_cols", "configure_grouping_strategy"],
        "split_relocs_by_group": ["rename_reloc_cols", "configure_grouping_strategy"],
        "convert_to_trajectories": ["rename_reloc_cols"],
        "add_temporal_index_to_traj": [
            "convert_to_trajectories",
            "configure_grouping_strategy",
        ],
        "classify_trajectory_speed_bins": ["add_temporal_index_to_traj"],
        "rename_trajectory_cols": ["classify_trajectory_speed_bins"],
        "split_trajs_by_group": [
            "rename_trajectory_cols",
            "configure_grouping_strategy",
        ],
        "sort_trajs_by_speed": ["split_trajs_by_group"],
        "apply_speed_colormap": ["sort_trajs_by_speed"],
        "format_speed_bin_labels": ["apply_speed_colormap"],
        "format_speed_values": ["format_speed_bin_labels"],
        "generate_speedmap_layers": ["format_speed_values"],
        "zoom_traj_view": ["format_speed_values"],
        "combine_landdx_speed_layers": [
            "create_styled_ldx_layers",
            "generate_speedmap_layers",
        ],
        "speedvalues_view_zip": ["combine_landdx_speed_layers", "zoom_traj_view"],
        "draw_speedmap": ["configure_base_maps", "speedvalues_view_zip"],
        "persist_speed_ecomap_urls": ["draw_speedmap"],
        "create_speed_ecomap_widgets": ["persist_speed_ecomap_urls"],
        "merge_speed_ecomap_widgets": ["create_speed_ecomap_widgets"],
        "generate_etd": ["split_trajs_by_group"],
        "determine_seasonal_windows": [
            "gee_client",
            "define_time_range",
            "generate_etd",
        ],
        "zip_etd_and_grouped_trajs": [
            "determine_seasonal_windows",
            "split_trajs_by_group",
        ],
        "add_season_labels": ["zip_etd_and_grouped_trajs"],
        "calculate_mcp": ["split_trajs_by_group"],
        "apply_etd_percentile_colormap": ["generate_etd"],
        "generate_etd_ecomap_layers": ["apply_etd_percentile_colormap"],
        "zoom_hr_view": ["apply_etd_percentile_colormap"],
        "combine_landdx_hr_ecomap_layers": [
            "create_styled_ldx_layers",
            "generate_etd_ecomap_layers",
        ],
        "hr_view_zip": ["combine_landdx_hr_ecomap_layers", "zoom_hr_view"],
        "draw_hr_ecomaps": ["configure_base_maps", "hr_view_zip"],
        "persist_hr_ecomap_urls": ["draw_hr_ecomaps"],
        "create_hr_ecomap_widgets": ["persist_hr_ecomap_urls"],
        "merge_hr_ecomap_widgets": ["create_hr_ecomap_widgets"],
        "seasonal_home_range": ["add_season_labels"],
        "season_colormap": ["seasonal_home_range"],
        "season_etd_map_layer": ["season_colormap"],
        "generate_mcp_layers": ["calculate_mcp"],
        "zip_season_mcp_hr": ["generate_mcp_layers", "season_etd_map_layer"],
        "zoom_season_view": ["season_colormap"],
        "comb_season_map_layers": ["create_styled_ldx_layers", "zip_season_mcp_hr"],
        "seasons_view_zip": ["comb_season_map_layers", "zoom_season_view"],
        "seasonal_ecomap": ["configure_base_maps", "seasons_view_zip"],
        "season_etd_ecomap_html_url": ["seasonal_ecomap"],
        "season_etd_widgets_single_view": ["season_etd_ecomap_html_url"],
        "season_grouped_map_widget": ["season_etd_widgets_single_view"],
        "persist_subject_season_wins": ["determine_seasonal_windows"],
        "zip_nsd_values": ["split_relocs_by_group", "persist_subject_season_wins"],
        "generate_nsd_plot": ["zip_nsd_values"],
        "persist_nsd_html_urls": ["generate_nsd_plot"],
        "nsd_plot_widgets_single_view": ["persist_nsd_html_urls"],
        "grouped_nsd_plot_widget": ["nsd_plot_widgets_single_view"],
        "zip_speed_values": ["split_relocs_by_group", "persist_subject_season_wins"],
        "generate_speed_plot": ["zip_speed_values"],
        "persist_speed_html_urls": ["generate_speed_plot"],
        "speed_plot_widgets_single_view": ["persist_speed_html_urls"],
        "grouped_speed_plot_widget": ["speed_plot_widgets_single_view"],
        "zip_collared_subject_values": [
            "split_relocs_by_group",
            "persist_subject_season_wins",
        ],
        "generate_colared_subject_plot": [
            "rename_event_cols",
            "zip_collared_subject_values",
        ],
        "persist_collared_subject_plots": ["generate_colared_subject_plot"],
        "collared_widget_view": ["persist_collared_subject_plots"],
        "grouped_collared_widget": ["collared_widget_view"],
        "zip_mcp_asymp_values": [
            "split_relocs_by_group",
            "persist_subject_season_wins",
        ],
        "generate_mcp_asymp_plot": ["zip_mcp_asymp_values"],
        "persist_mcp_html_urls": ["generate_mcp_asymp_plot"],
        "mcp_plot_widgets_single_view": ["persist_mcp_html_urls"],
        "grouped_mcp_plot_widget": ["mcp_plot_widgets_single_view"],
        "zip_traj_etd_gdf": ["generate_etd", "split_trajs_by_group"],
        "generate_subject_stats": ["compute_subject_maturity", "zip_traj_etd_gdf"],
        "persist_subject_stats": ["generate_subject_stats"],
        "load_unfiltered_ldx": ["retrieve_ldx_db"],
        "zip_etd_subjects": ["generate_etd", "split_subject_by_group"],
        "build_region_lookup": ["load_unfiltered_ldx"],
        "comp_template_regions": ["load_unfiltered_ldx", "build_region_lookup"],
        "process_subject_occupancy": ["comp_template_regions", "zip_etd_subjects"],
        "persist_subject_occupancy": ["process_subject_occupancy"],
        "convt_range_html_png": ["persist_hr_ecomap_urls"],
        "convt_speedmap_html_png": ["persist_speed_ecomap_urls"],
        "convt_seasons_html_png": ["season_etd_ecomap_html_url"],
        "convt_nsdp_html_png": ["persist_nsd_html_urls"],
        "convt_mcp_html_png": ["persist_mcp_html_urls"],
        "convt_speedp_html_png": ["persist_speed_html_urls"],
        "convt_colev_html_png": ["persist_collared_subject_plots"],
        "zip_movement_range_maps": ["convt_speedmap_html_png", "convt_range_html_png"],
        "zip_range_mov_overview": ["zip_movement_range_maps", "convt_seasons_html_png"],
        "zip_range_subject_photo": ["zip_range_mov_overview", "download_profile_pic"],
        "zip_items_w_collared": ["zip_range_subject_photo", "convt_colev_html_png"],
        "zip_with_nsd": ["zip_items_w_collared", "convt_nsdp_html_png"],
        "zip_with_speed": ["zip_with_nsd", "convt_speedp_html_png"],
        "zip_with_mcp": ["zip_with_speed", "convt_mcp_html_png"],
        "zip_subject_info": ["zip_with_mcp", "persist_subject_info"],
        "zip_subject_stats": ["zip_subject_info", "persist_subject_stats"],
        "zip_occupancy_info": ["zip_subject_stats", "persist_subject_occupancy"],
        "flatten_collared_context": ["zip_occupancy_info"],
        "view_flatten_data": ["flatten_collared_context"],
        "generate_report_context": [
            "compute_subject_maturity",
            "download_template_one",
            "download_template_two",
            "download_template_three",
            "download_logo",
            "flatten_collared_context",
        ],
        "render_html_pdf": ["generate_report_context"],
        "merge_subject_pdf": ["compute_subject_maturity", "render_html_pdf"],
        "collared_report_template": [
            "workflow_details",
            "merge_speed_ecomap_widgets",
            "merge_hr_ecomap_widgets",
            "season_grouped_map_widget",
            "grouped_nsd_plot_widget",
            "grouped_speed_plot_widget",
            "grouped_collared_widget",
            "grouped_mcp_plot_widget",
            "define_time_range",
            "configure_grouping_strategy",
        ],
    }

    nodes = {
        "workflow_details": Node(
            async_task=set_workflow_details.validate()
            .handle_errors(task_instance_id="workflow_details")
            .set_executor("lithops"),
            partial=(params_dict.get("workflow_details") or {}),
            method="call",
        ),
        "gee_client": Node(
            async_task=set_gee_connection.validate()
            .handle_errors(task_instance_id="gee_client")
            .set_executor("lithops"),
            partial=(params_dict.get("gee_client") or {}),
            method="call",
        ),
        "er_client": Node(
            async_task=set_er_connection.validate()
            .handle_errors(task_instance_id="er_client")
            .set_executor("lithops"),
            partial=(params_dict.get("er_client") or {}),
            method="call",
        ),
        "configure_base_maps": Node(
            async_task=set_base_maps.validate()
            .handle_errors(task_instance_id="configure_base_maps")
            .set_executor("lithops"),
            partial=(params_dict.get("configure_base_maps") or {}),
            method="call",
        ),
        "configure_grouping_strategy": Node(
            async_task=set_groupers.validate()
            .handle_errors(task_instance_id="configure_grouping_strategy")
            .set_executor("lithops"),
            partial=(params_dict.get("configure_grouping_strategy") or {}),
            method="call",
        ),
        "define_time_range": Node(
            async_task=set_time_range.validate()
            .handle_errors(task_instance_id="define_time_range")
            .set_executor("lithops"),
            partial={
                "time_format": "%d %b %Y %H:%M:%S %Z",
            }
            | (params_dict.get("define_time_range") or {}),
            method="call",
        ),
        "retrieve_ldx_db": Node(
            async_task=download_file_and_persist.validate()
            .handle_errors(task_instance_id="retrieve_ldx_db")
            .set_executor("lithops"),
            partial={
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "url": "https://maraelephant.maps.arcgis.com/sharing/rest/content/items/6da0c9bdd43d4dd0ac59a4f3cd73dcab/data",
                "unzip": True,
            }
            | (params_dict.get("retrieve_ldx_db") or {}),
            method="call",
        ),
        "download_logo": Node(
            async_task=download_file_and_persist.validate()
            .handle_errors(task_instance_id="download_logo")
            .set_executor("lithops"),
            partial={
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "overwrite_existing": False,
            }
            | (params_dict.get("download_logo") or {}),
            method="call",
        ),
        "download_template_one": Node(
            async_task=download_file_and_persist.validate()
            .handle_errors(task_instance_id="download_template_one")
            .set_executor("lithops"),
            partial={
                "url": "https://www.dropbox.com/scl/fi/6yruu5uyino3gmzasdfy0/template_1.html?rlkey=w7haw2q8hkpv1ocsms0zq92rw&st=7bak4xbj&dl=0",
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "overwrite_existing": False,
            }
            | (params_dict.get("download_template_one") or {}),
            method="call",
        ),
        "download_template_two": Node(
            async_task=download_file_and_persist.validate()
            .handle_errors(task_instance_id="download_template_two")
            .set_executor("lithops"),
            partial={
                "url": "https://www.dropbox.com/scl/fi/6skjcsspv9rf5jgsyedgt/template_2.html?rlkey=lk73uq9m506ve9qsmghkk57k2&st=6lbck9k3&dl=0",
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "overwrite_existing": False,
            }
            | (params_dict.get("download_template_two") or {}),
            method="call",
        ),
        "download_template_three": Node(
            async_task=download_file_and_persist.validate()
            .handle_errors(task_instance_id="download_template_three")
            .set_executor("lithops"),
            partial={
                "url": "https://www.dropbox.com/scl/fi/44yv82b85lws8u657nuoy/template_3.html?rlkey=b0bdy09kb2oom13rvmd6r3gbc&st=550bazn1&dl=0",
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "overwrite_existing": False,
            }
            | (params_dict.get("download_template_three") or {}),
            method="call",
        ),
        "load_aoi": Node(
            async_task=load_landdx_aoi.validate()
            .handle_errors(task_instance_id="load_aoi")
            .set_executor("lithops"),
            partial={
                "map_path": DependsOn("retrieve_ldx_db"),
            }
            | (params_dict.get("load_aoi") or {}),
            method="call",
        ),
        "split_landdx_by_type": Node(
            async_task=split_gdf_by_column.validate()
            .handle_errors(task_instance_id="split_landdx_by_type")
            .set_executor("lithops"),
            partial={
                "gdf": DependsOn("load_aoi"),
                "column": "type",
            }
            | (params_dict.get("split_landdx_by_type") or {}),
            method="call",
        ),
        "annotate_geom_types": Node(
            async_task=annotate_gdf_dict_with_geometry_type.validate()
            .handle_errors(task_instance_id="annotate_geom_types")
            .set_executor("lithops"),
            partial={
                "gdf_dict": DependsOn("split_landdx_by_type"),
            }
            | (params_dict.get("annotate_geom_types") or {}),
            method="call",
        ),
        "create_styled_ldx_layers": Node(
            async_task=create_map_layers_from_annotated_dict.validate()
            .handle_errors(task_instance_id="create_styled_ldx_layers")
            .set_executor("lithops"),
            partial={
                "annotated_dict": DependsOn("annotate_geom_types"),
            }
            | (params_dict.get("create_styled_ldx_layers") or {}),
            method="call",
        ),
        "subject_df": Node(
            async_task=get_subjects_info.validate()
            .handle_errors(task_instance_id="subject_df")
            .set_executor("lithops"),
            partial={
                "client": DependsOn("er_client"),
                "include_inactive": True,
            }
            | (params_dict.get("subject_df") or {}),
            method="call",
        ),
        "normalize_subject_info": Node(
            async_task=normalize_column.validate()
            .handle_errors(task_instance_id="normalize_subject_info")
            .set_executor("lithops"),
            partial={
                "column": "additional",
                "df": DependsOn("subject_df"),
            }
            | (params_dict.get("normalize_subject_info") or {}),
            method="call",
        ),
        "rename_subject_cols": Node(
            async_task=map_columns.validate()
            .handle_errors(task_instance_id="rename_subject_cols")
            .set_executor("lithops"),
            partial={
                "drop_columns": [
                    "url",
                    "image_url",
                    "common_name",
                    "content_type",
                    "additional__external_id",
                    "additional__tm_animal_id",
                    "additional__external_name",
                ],
                "retain_columns": [
                    "id",
                    "name",
                    "hex",
                    "additional__rgb",
                    "additional__sex",
                    "additional__Bio",
                    "additional__DOB",
                    "additional__notes",
                    "additional__status",
                    "additional__region",
                    "additional__country",
                    "additional__id_photo",
                    "additional__distribution",
                ],
                "rename_columns": {
                    "id": "groupby_col",
                    "name": "subject_name",
                    "hex": "hex_color",
                    "additional__rgb": "rgb",
                    "additional__Bio": "subject_bio",
                    "additional__sex": "subject_sex",
                    "additional__DOB": "date_of_birth",
                    "additional__notes": "notes",
                    "additional__status": "status",
                    "additional__region": "region",
                    "additional__country": "country",
                    "additional__id_photo": "photo",
                    "additional__distribution": "distribution",
                },
                "df": DependsOn("normalize_subject_info"),
            }
            | (params_dict.get("rename_subject_cols") or {}),
            method="call",
        ),
        "subject_observations": Node(
            async_task=get_subjectgroup_observations.validate()
            .handle_errors(task_instance_id="subject_observations")
            .set_executor("lithops"),
            partial={
                "client": DependsOn("er_client"),
                "time_range": DependsOn("define_time_range"),
                "raise_on_empty": False,
                "include_details": False,
                "include_subjectsource_details": False,
            }
            | (params_dict.get("subject_observations") or {}),
            method="call",
        ),
        "subject_relocations": Node(
            async_task=process_relocations.validate()
            .handle_errors(task_instance_id="subject_relocations")
            .set_executor("lithops"),
            partial={
                "observations": DependsOn("subject_observations"),
                "relocs_columns": [
                    "fixtime",
                    "geometry",
                    "groupby_col",
                    "junk_status",
                    "extra__created_at",
                    "extra__subject__sex",
                    "extra__subject__hex",
                    "extra__subject__name",
                    "extra__subject__subject_subtype",
                ],
                "filter_point_coords": [
                    {"x": 180.0, "y": 90.0},
                    {"x": 0.0, "y": 0.0},
                    {"x": 1.0, "y": 1.0},
                ],
            }
            | (params_dict.get("subject_relocations") or {}),
            method="call",
        ),
        "inspect_relocations_df": Node(
            async_task=view_df.validate()
            .handle_errors(task_instance_id="inspect_relocations_df")
            .set_executor("lithops"),
            partial={
                "gdf": DependsOn("subject_relocations"),
                "name": "Relocs",
            }
            | (params_dict.get("inspect_relocations_df") or {}),
            method="call",
        ),
        "rename_reloc_cols": Node(
            async_task=map_columns.validate()
            .handle_errors(task_instance_id="rename_reloc_cols")
            .set_executor("lithops"),
            partial={
                "drop_columns": [],
                "retain_columns": [],
                "rename_columns": {
                    "name": "subject_name",
                    "hex": "hex_color",
                    "sex": "subject_sex",
                    "subject_subtype": "subject_subtype",
                    "created_at": "created_at",
                },
                "df": DependsOn("subject_relocations"),
            }
            | (params_dict.get("rename_reloc_cols") or {}),
            method="call",
        ),
        "compute_subject_maturity": Node(
            async_task=compute_maturity.validate()
            .handle_errors(task_instance_id="compute_subject_maturity")
            .set_executor("lithops"),
            partial={
                "subject_df": DependsOn("rename_subject_cols"),
                "relocations_gdf": DependsOn("rename_reloc_cols"),
                "months_duration": 6,
            }
            | (params_dict.get("compute_subject_maturity") or {}),
            method="call",
        ),
        "split_subject_by_group": Node(
            async_task=split_groups.validate()
            .handle_errors(task_instance_id="split_subject_by_group")
            .set_executor("lithops"),
            partial={
                "df": DependsOn("compute_subject_maturity"),
                "groupers": DependsOn("configure_grouping_strategy"),
            }
            | (params_dict.get("split_subject_by_group") or {}),
            method="call",
        ),
        "download_profile_pic": Node(
            async_task=download_profile_photo.validate()
            .handle_errors(task_instance_id="download_profile_pic")
            .set_executor("lithops"),
            partial={
                "image_type": ".png",
                "column": "photo",
                "overwrite_existing": True,
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("download_profile_pic") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["subject_df"],
                "argvalues": DependsOn("split_subject_by_group"),
            },
        ),
        "download_subject_info": Node(
            async_task=generate_subject_info.validate()
            .handle_errors(task_instance_id="download_subject_info")
            .set_executor("lithops"),
            partial={
                "maxlen": 1000,
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("download_subject_info") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["subject_df"],
                "argvalues": DependsOn("split_subject_by_group"),
            },
        ),
        "persist_subject_info": Node(
            async_task=persist_df.validate()
            .handle_errors(task_instance_id="persist_subject_info")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_subject_info") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("download_subject_info"),
            },
        ),
        "get_events_data": Node(
            async_task=get_events.validate()
            .handle_errors(task_instance_id="get_events_data")
            .set_executor("lithops"),
            partial={
                "client": DependsOn("er_client"),
                "time_range": DependsOn("define_time_range"),
                "include_details": True,
                "raise_on_empty": True,
                "event_columns": [
                    "id",
                    "time",
                    "event_type",
                    "event_category",
                    "reported_by",
                    "serial_number",
                    "geometry",
                    "event_details",
                ],
            }
            | (params_dict.get("get_events_data") or {}),
            method="call",
        ),
        "normalize_event_details": Node(
            async_task=normalize_column.validate()
            .handle_errors(task_instance_id="normalize_event_details")
            .set_executor("lithops"),
            partial={
                "column": "event_details",
                "df": DependsOn("get_events_data"),
            }
            | (params_dict.get("normalize_event_details") or {}),
            method="call",
        ),
        "rename_event_cols": Node(
            async_task=map_columns.validate()
            .handle_errors(task_instance_id="rename_event_cols")
            .skipif(
                conditions=[
                    any_is_empty_df,
                    any_dependency_skipped,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "drop_columns": [],
                "retain_columns": [],
                "rename_columns": {
                    "event_details__pic": "pic",
                    "event_details__region": "region",
                    "event_details__source": "source",
                    "event_details__details": "details",
                    "event_details__subject": "groupby_col",
                    "event_details__source_id": "source_id",
                    "event_details__subject_id": "subject_name",
                    "event_details__collaring_type": "collaring_type",
                    "event_details__collaring_reason": "collaring_reason",
                    "event_details__collar_checked_by": "collar_checked_by",
                },
                "df": DependsOn("normalize_event_details"),
            }
            | (params_dict.get("rename_event_cols") or {}),
            method="call",
        ),
        "split_events_by_group": Node(
            async_task=split_groups.validate()
            .handle_errors(task_instance_id="split_events_by_group")
            .set_executor("lithops"),
            partial={
                "df": DependsOn("rename_event_cols"),
                "groupers": DependsOn("configure_grouping_strategy"),
            }
            | (params_dict.get("split_events_by_group") or {}),
            method="call",
        ),
        "split_relocs_by_group": Node(
            async_task=split_groups.validate()
            .handle_errors(task_instance_id="split_relocs_by_group")
            .set_executor("lithops"),
            partial={
                "df": DependsOn("rename_reloc_cols"),
                "groupers": DependsOn("configure_grouping_strategy"),
            }
            | (params_dict.get("split_relocs_by_group") or {}),
            method="call",
        ),
        "convert_to_trajectories": Node(
            async_task=relocations_to_trajectory.validate()
            .handle_errors(task_instance_id="convert_to_trajectories")
            .set_executor("lithops"),
            partial={
                "relocations": DependsOn("rename_reloc_cols"),
            }
            | (params_dict.get("convert_to_trajectories") or {}),
            method="call",
        ),
        "add_temporal_index_to_traj": Node(
            async_task=add_temporal_index.validate()
            .handle_errors(task_instance_id="add_temporal_index_to_traj")
            .set_executor("lithops"),
            partial={
                "df": DependsOn("convert_to_trajectories"),
                "time_col": "segment_start",
                "groupers": DependsOn("configure_grouping_strategy"),
                "cast_to_datetime": True,
                "format": "mixed",
            }
            | (params_dict.get("add_temporal_index_to_traj") or {}),
            method="call",
        ),
        "classify_trajectory_speed_bins": Node(
            async_task=apply_classification.validate()
            .handle_errors(task_instance_id="classify_trajectory_speed_bins")
            .set_executor("lithops"),
            partial={
                "df": DependsOn("add_temporal_index_to_traj"),
                "input_column_name": "speed_kmhr",
                "output_column_name": "speed_bins",
                "classification_options": {"scheme": "equal_interval", "k": 6},
                "label_options": {"label_ranges": False, "label_decimals": 1},
            }
            | (params_dict.get("classify_trajectory_speed_bins") or {}),
            method="call",
        ),
        "rename_trajectory_cols": Node(
            async_task=map_columns.validate()
            .handle_errors(task_instance_id="rename_trajectory_cols")
            .set_executor("lithops"),
            partial={
                "drop_columns": [],
                "retain_columns": [],
                "rename_columns": {
                    "extra__subject_name": "subject_name",
                    "extra__hex_color": "hex_color",
                    "extra__subject_sex": "subject_sex",
                    "extra__subject_subtype": "subject_subtype",
                },
                "df": DependsOn("classify_trajectory_speed_bins"),
            }
            | (params_dict.get("rename_trajectory_cols") or {}),
            method="call",
        ),
        "split_trajs_by_group": Node(
            async_task=split_groups.validate()
            .handle_errors(task_instance_id="split_trajs_by_group")
            .set_executor("lithops"),
            partial={
                "df": DependsOn("rename_trajectory_cols"),
                "groupers": DependsOn("configure_grouping_strategy"),
            }
            | (params_dict.get("split_trajs_by_group") or {}),
            method="call",
        ),
        "sort_trajs_by_speed": Node(
            async_task=sort_values.validate()
            .handle_errors(task_instance_id="sort_trajs_by_speed")
            .set_executor("lithops"),
            partial={
                "column_name": "speed_bins",
                "na_position": "last",
            }
            | (params_dict.get("sort_trajs_by_speed") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("split_trajs_by_group"),
            },
        ),
        "apply_speed_colormap": Node(
            async_task=apply_color_map.validate()
            .handle_errors(task_instance_id="apply_speed_colormap")
            .set_executor("lithops"),
            partial={
                "input_column_name": "speed_bins",
                "output_column_name": "speed_bins_colormap",
                "colormap": [
                    "#1a9850",
                    "#91cf60",
                    "#d9ef8b",
                    "#fee08b",
                    "#fc8d59",
                    "#d73027",
                ],
            }
            | (params_dict.get("apply_speed_colormap") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("sort_trajs_by_speed"),
            },
        ),
        "format_speed_bin_labels": Node(
            async_task=map_values_with_unit.validate()
            .handle_errors(task_instance_id="format_speed_bin_labels")
            .set_executor("lithops"),
            partial={
                "input_column_name": "speed_bins",
                "output_column_name": "speed_bins_formatted",
                "original_unit": "km/h",
                "new_unit": "km/h",
                "decimal_places": 1,
            }
            | (params_dict.get("format_speed_bin_labels") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("apply_speed_colormap"),
            },
        ),
        "format_speed_values": Node(
            async_task=map_values_with_unit.validate()
            .handle_errors(task_instance_id="format_speed_values")
            .set_executor("lithops"),
            partial={
                "input_column_name": "speed_kmhr",
                "output_column_name": "speed_kmhr",
                "original_unit": "km/h",
                "new_unit": "km/h",
                "decimal_places": 1,
            }
            | (params_dict.get("format_speed_values") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("format_speed_bin_labels"),
            },
        ),
        "generate_speedmap_layers": Node(
            async_task=create_polyline_layer.validate()
            .handle_errors(task_instance_id="generate_speedmap_layers")
            .skipif(
                conditions=[
                    any_is_empty_df,
                    any_dependency_skipped,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "layer_style": {"color_column": "speed_bins_colormap"},
                "legend": {
                    "label_column": "speed_bins_formatted",
                    "color_column": "speed_bins_colormap",
                },
                "tooltip_columns": [
                    "subject_name",
                    "subject_sex",
                    "subject_subtype",
                    "speed_kmhr",
                    "speed_bins",
                    "dist_meters",
                ],
            }
            | (params_dict.get("generate_speedmap_layers") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["geodataframe"],
                "argvalues": DependsOn("format_speed_values"),
            },
        ),
        "zoom_traj_view": Node(
            async_task=create_view_state_from_gdf.validate()
            .handle_errors(task_instance_id="zoom_traj_view")
            .set_executor("lithops"),
            partial={
                "pitch": 0,
                "bearing": 0,
            }
            | (params_dict.get("zoom_traj_view") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["gdf"],
                "argvalues": DependsOn("format_speed_values"),
            },
        ),
        "combine_landdx_speed_layers": Node(
            async_task=combine_map_layers.validate()
            .handle_errors(task_instance_id="combine_landdx_speed_layers")
            .set_executor("lithops"),
            partial={
                "static_layers": DependsOn("create_styled_ldx_layers"),
            }
            | (params_dict.get("combine_landdx_speed_layers") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["grouped_layers"],
                "argvalues": DependsOn("generate_speedmap_layers"),
            },
        ),
        "speedvalues_view_zip": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="speedvalues_view_zip")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("combine_landdx_speed_layers"),
                "right": DependsOn("zoom_traj_view"),
            }
            | (params_dict.get("speedvalues_view_zip") or {}),
            method="call",
        ),
        "draw_speedmap": Node(
            async_task=draw_ecomap.validate()
            .handle_errors(task_instance_id="draw_speedmap")
            .set_executor("lithops"),
            partial={
                "tile_layers": DependsOn("configure_base_maps"),
                "north_arrow_style": {"placement": "top-left"},
                "legend_style": {
                    "placement": "bottom-right",
                    "title": "Speed Values(Km/h)",
                },
                "static": False,
                "title": None,
                "max_zoom": 20,
            }
            | (params_dict.get("draw_speedmap") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["geo_layers", "view_state"],
                "argvalues": DependsOn("speedvalues_view_zip"),
            },
        ),
        "persist_speed_ecomap_urls": Node(
            async_task=persist_text.validate()
            .handle_errors(task_instance_id="persist_speed_ecomap_urls")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_speed_ecomap_urls") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["text"],
                "argvalues": DependsOn("draw_speedmap"),
            },
        ),
        "create_speed_ecomap_widgets": Node(
            async_task=create_map_widget_single_view.validate()
            .handle_errors(task_instance_id="create_speed_ecomap_widgets")
            .skipif(
                conditions=[
                    never,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "title": "Speedmap",
            }
            | (params_dict.get("create_speed_ecomap_widgets") or {}),
            method="map",
            kwargs={
                "argnames": ["view", "data"],
                "argvalues": DependsOn("persist_speed_ecomap_urls"),
            },
        ),
        "merge_speed_ecomap_widgets": Node(
            async_task=merge_widget_views.validate()
            .handle_errors(task_instance_id="merge_speed_ecomap_widgets")
            .set_executor("lithops"),
            partial={
                "widgets": DependsOn("create_speed_ecomap_widgets"),
            }
            | (params_dict.get("merge_speed_ecomap_widgets") or {}),
            method="call",
        ),
        "generate_etd": Node(
            async_task=calculate_elliptical_time_density.validate()
            .handle_errors(task_instance_id="generate_etd")
            .set_executor("lithops"),
            partial={
                "crs": "ESRI:53042",
                "percentiles": [50.0, 60.0, 70.0, 80.0, 90.0, 95.0, 99.9],
                "nodata_value": "nan",
                "band_count": 1,
            }
            | (params_dict.get("generate_etd") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["trajectory_gdf"],
                "argvalues": DependsOn("split_trajs_by_group"),
            },
        ),
        "determine_seasonal_windows": Node(
            async_task=determine_season_windows.validate()
            .handle_errors(task_instance_id="determine_seasonal_windows")
            .set_executor("lithops"),
            partial={
                "client": DependsOn("gee_client"),
                "time_range": DependsOn("define_time_range"),
            }
            | (params_dict.get("determine_seasonal_windows") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["roi"],
                "argvalues": DependsOn("generate_etd"),
            },
        ),
        "zip_etd_and_grouped_trajs": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_etd_and_grouped_trajs")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("determine_seasonal_windows"),
                "right": DependsOn("split_trajs_by_group"),
            }
            | (params_dict.get("zip_etd_and_grouped_trajs") or {}),
            method="call",
        ),
        "add_season_labels": Node(
            async_task=create_seasonal_labels.validate()
            .handle_errors(task_instance_id="add_season_labels")
            .set_executor("lithops"),
            partial=(params_dict.get("add_season_labels") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["total_percentiles", "traj"],
                "argvalues": DependsOn("zip_etd_and_grouped_trajs"),
            },
        ),
        "calculate_mcp": Node(
            async_task=generate_mcp_gdf.validate()
            .handle_errors(task_instance_id="calculate_mcp")
            .set_executor("lithops"),
            partial={
                "planar_crs": "ESRI:53042",
            }
            | (params_dict.get("calculate_mcp") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["gdf"],
                "argvalues": DependsOn("split_trajs_by_group"),
            },
        ),
        "apply_etd_percentile_colormap": Node(
            async_task=apply_color_map.validate()
            .handle_errors(task_instance_id="apply_etd_percentile_colormap")
            .set_executor("lithops"),
            partial={
                "input_column_name": "percentile",
                "colormap": "RdYlGn",
                "output_column_name": "percentile_colormap",
            }
            | (params_dict.get("apply_etd_percentile_colormap") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("generate_etd"),
            },
        ),
        "generate_etd_ecomap_layers": Node(
            async_task=create_polygon_layer.validate()
            .handle_errors(task_instance_id="generate_etd_ecomap_layers")
            .skipif(
                conditions=[
                    any_is_empty_df,
                    any_dependency_skipped,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "layer_style": {
                    "fill_color_column": "percentile_colormap",
                    "opacity": 0.55,
                },
                "legend": {
                    "label_column": "percentile",
                    "color_column": "percentile_colormap",
                },
                "tooltip_columns": ["percentile"],
            }
            | (params_dict.get("generate_etd_ecomap_layers") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["geodataframe"],
                "argvalues": DependsOn("apply_etd_percentile_colormap"),
            },
        ),
        "zoom_hr_view": Node(
            async_task=create_view_state_from_gdf.validate()
            .handle_errors(task_instance_id="zoom_hr_view")
            .set_executor("lithops"),
            partial={
                "pitch": 0,
                "bearing": 0,
            }
            | (params_dict.get("zoom_hr_view") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["gdf"],
                "argvalues": DependsOn("apply_etd_percentile_colormap"),
            },
        ),
        "combine_landdx_hr_ecomap_layers": Node(
            async_task=combine_map_layers.validate()
            .handle_errors(task_instance_id="combine_landdx_hr_ecomap_layers")
            .set_executor("lithops"),
            partial={
                "static_layers": DependsOn("create_styled_ldx_layers"),
            }
            | (params_dict.get("combine_landdx_hr_ecomap_layers") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["grouped_layers"],
                "argvalues": DependsOn("generate_etd_ecomap_layers"),
            },
        ),
        "hr_view_zip": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="hr_view_zip")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("combine_landdx_hr_ecomap_layers"),
                "right": DependsOn("zoom_hr_view"),
            }
            | (params_dict.get("hr_view_zip") or {}),
            method="call",
        ),
        "draw_hr_ecomaps": Node(
            async_task=draw_ecomap.validate()
            .handle_errors(task_instance_id="draw_hr_ecomaps")
            .set_executor("lithops"),
            partial={
                "tile_layers": DependsOn("configure_base_maps"),
                "north_arrow_style": {"placement": "top-left"},
                "legend_style": {
                    "placement": "bottom-right",
                    "title": "Home Range Metrics",
                },
                "static": False,
                "title": None,
                "max_zoom": 20,
            }
            | (params_dict.get("draw_hr_ecomaps") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["geo_layers", "view_state"],
                "argvalues": DependsOn("hr_view_zip"),
            },
        ),
        "persist_hr_ecomap_urls": Node(
            async_task=persist_text.validate()
            .handle_errors(task_instance_id="persist_hr_ecomap_urls")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_hr_ecomap_urls") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["text"],
                "argvalues": DependsOn("draw_hr_ecomaps"),
            },
        ),
        "create_hr_ecomap_widgets": Node(
            async_task=create_map_widget_single_view.validate()
            .handle_errors(task_instance_id="create_hr_ecomap_widgets")
            .skipif(
                conditions=[
                    never,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "title": "Home Range Ecomap",
            }
            | (params_dict.get("create_hr_ecomap_widgets") or {}),
            method="map",
            kwargs={
                "argnames": ["view", "data"],
                "argvalues": DependsOn("persist_hr_ecomap_urls"),
            },
        ),
        "merge_hr_ecomap_widgets": Node(
            async_task=merge_widget_views.validate()
            .handle_errors(task_instance_id="merge_hr_ecomap_widgets")
            .set_executor("lithops"),
            partial={
                "widgets": DependsOn("create_hr_ecomap_widgets"),
            }
            | (params_dict.get("merge_hr_ecomap_widgets") or {}),
            method="call",
        ),
        "seasonal_home_range": Node(
            async_task=calculate_seasonal_home_range.validate()
            .handle_errors(task_instance_id="seasonal_home_range")
            .skipif(
                conditions=[
                    any_is_empty_df,
                    all_geometry_are_none,
                    any_dependency_skipped,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "groupby_cols": ["subject_name", "season"],
            }
            | (params_dict.get("seasonal_home_range") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["gdf"],
                "argvalues": DependsOn("add_season_labels"),
            },
        ),
        "season_colormap": Node(
            async_task=apply_color_map.validate()
            .handle_errors(task_instance_id="season_colormap")
            .set_executor("lithops"),
            partial={
                "input_column_name": "season",
                "output_column_name": "season_colormap",
                "colormap": ["#f57c00", "#4cf3f7"],
            }
            | (params_dict.get("season_colormap") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("seasonal_home_range"),
            },
        ),
        "season_etd_map_layer": Node(
            async_task=create_polygon_layer.validate()
            .handle_errors(task_instance_id="season_etd_map_layer")
            .skipif(
                conditions=[
                    any_is_empty_df,
                    any_dependency_skipped,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "layer_style": {
                    "fill_color_column": "season_colormap",
                    "opacity": 0.65,
                },
                "legend": {"label_column": "season", "color_column": "season_colormap"},
                "tooltip_columns": ["percentile"],
            }
            | (params_dict.get("season_etd_map_layer") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["geodataframe"],
                "argvalues": DependsOn("season_colormap"),
            },
        ),
        "generate_mcp_layers": Node(
            async_task=create_polygon_layer.validate()
            .handle_errors(task_instance_id="generate_mcp_layers")
            .skipif(
                conditions=[
                    any_is_empty_df,
                    any_dependency_skipped,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "layer_style": {
                    "get_fill_color": "#FFFFFF00",
                    "get_line_color": "#dc143c",
                    "opacity": 0.55,
                    "stroked": True,
                },
                "legend": {"labels": ["mcp"], "colors": ["#dc143c"]},
                "tooltip_columns": ["area_km2"],
            }
            | (params_dict.get("generate_mcp_layers") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["geodataframe"],
                "argvalues": DependsOn("calculate_mcp"),
            },
        ),
        "zip_season_mcp_hr": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_season_mcp_hr")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("generate_mcp_layers"),
                "right": DependsOn("season_etd_map_layer"),
            }
            | (params_dict.get("zip_season_mcp_hr") or {}),
            method="call",
        ),
        "zoom_season_view": Node(
            async_task=create_view_state_from_gdf.validate()
            .handle_errors(task_instance_id="zoom_season_view")
            .set_executor("lithops"),
            partial={
                "pitch": 0,
                "bearing": 0,
            }
            | (params_dict.get("zoom_season_view") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["gdf"],
                "argvalues": DependsOn("season_colormap"),
            },
        ),
        "comb_season_map_layers": Node(
            async_task=combine_map_layers.validate()
            .handle_errors(task_instance_id="comb_season_map_layers")
            .set_executor("lithops"),
            partial={
                "static_layers": DependsOn("create_styled_ldx_layers"),
            }
            | (params_dict.get("comb_season_map_layers") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["grouped_layers"],
                "argvalues": DependsOn("zip_season_mcp_hr"),
            },
        ),
        "seasons_view_zip": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="seasons_view_zip")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("comb_season_map_layers"),
                "right": DependsOn("zoom_season_view"),
            }
            | (params_dict.get("seasons_view_zip") or {}),
            method="call",
        ),
        "seasonal_ecomap": Node(
            async_task=draw_ecomap.validate()
            .handle_errors(task_instance_id="seasonal_ecomap")
            .set_executor("lithops"),
            partial={
                "tile_layers": DependsOn("configure_base_maps"),
                "north_arrow_style": {"placement": "top-left"},
                "legend_style": {"placement": "bottom-right", "title": "Seasons"},
                "static": False,
                "title": None,
                "max_zoom": 20,
            }
            | (params_dict.get("seasonal_ecomap") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["geo_layers", "view_state"],
                "argvalues": DependsOn("seasons_view_zip"),
            },
        ),
        "season_etd_ecomap_html_url": Node(
            async_task=persist_text.validate()
            .handle_errors(task_instance_id="season_etd_ecomap_html_url")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("season_etd_ecomap_html_url") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["text"],
                "argvalues": DependsOn("seasonal_ecomap"),
            },
        ),
        "season_etd_widgets_single_view": Node(
            async_task=create_map_widget_single_view.validate()
            .handle_errors(task_instance_id="season_etd_widgets_single_view")
            .skipif(
                conditions=[
                    never,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "title": "Subject Group Home Range Map (Seasons)",
            }
            | (params_dict.get("season_etd_widgets_single_view") or {}),
            method="map",
            kwargs={
                "argnames": ["view", "data"],
                "argvalues": DependsOn("season_etd_ecomap_html_url"),
            },
        ),
        "season_grouped_map_widget": Node(
            async_task=merge_widget_views.validate()
            .handle_errors(task_instance_id="season_grouped_map_widget")
            .set_executor("lithops"),
            partial={
                "widgets": DependsOn("season_etd_widgets_single_view"),
            }
            | (params_dict.get("season_grouped_map_widget") or {}),
            method="call",
        ),
        "persist_subject_season_wins": Node(
            async_task=persist_df.validate()
            .handle_errors(task_instance_id="persist_subject_season_wins")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_subject_season_wins") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("determine_seasonal_windows"),
            },
        ),
        "zip_nsd_values": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_nsd_values")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("split_relocs_by_group"),
                "right": DependsOn("persist_subject_season_wins"),
            }
            | (params_dict.get("zip_nsd_values") or {}),
            method="call",
        ),
        "generate_nsd_plot": Node(
            async_task=generate_seasonal_nsd_plot.validate()
            .handle_errors(task_instance_id="generate_nsd_plot")
            .set_executor("lithops"),
            partial=(params_dict.get("generate_nsd_plot") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["relocations_gdf", "seasons_df"],
                "argvalues": DependsOn("zip_nsd_values"),
            },
        ),
        "persist_nsd_html_urls": Node(
            async_task=persist_text.validate()
            .handle_errors(task_instance_id="persist_nsd_html_urls")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_nsd_html_urls") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["text"],
                "argvalues": DependsOn("generate_nsd_plot"),
            },
        ),
        "nsd_plot_widgets_single_view": Node(
            async_task=create_map_widget_single_view.validate()
            .handle_errors(task_instance_id="nsd_plot_widgets_single_view")
            .skipif(
                conditions=[
                    never,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "title": "Net Square Displacement (NSD)",
            }
            | (params_dict.get("nsd_plot_widgets_single_view") or {}),
            method="map",
            kwargs={
                "argnames": ["view", "data"],
                "argvalues": DependsOn("persist_nsd_html_urls"),
            },
        ),
        "grouped_nsd_plot_widget": Node(
            async_task=merge_widget_views.validate()
            .handle_errors(task_instance_id="grouped_nsd_plot_widget")
            .set_executor("lithops"),
            partial={
                "widgets": DependsOn("nsd_plot_widgets_single_view"),
            }
            | (params_dict.get("grouped_nsd_plot_widget") or {}),
            method="call",
        ),
        "zip_speed_values": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_speed_values")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("split_relocs_by_group"),
                "right": DependsOn("persist_subject_season_wins"),
            }
            | (params_dict.get("zip_speed_values") or {}),
            method="call",
        ),
        "generate_speed_plot": Node(
            async_task=generate_seasonal_speed_plot.validate()
            .handle_errors(task_instance_id="generate_speed_plot")
            .set_executor("lithops"),
            partial=(params_dict.get("generate_speed_plot") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["relocations_gdf", "seasons_df"],
                "argvalues": DependsOn("zip_speed_values"),
            },
        ),
        "persist_speed_html_urls": Node(
            async_task=persist_text.validate()
            .handle_errors(task_instance_id="persist_speed_html_urls")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_speed_html_urls") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["text"],
                "argvalues": DependsOn("generate_speed_plot"),
            },
        ),
        "speed_plot_widgets_single_view": Node(
            async_task=create_map_widget_single_view.validate()
            .handle_errors(task_instance_id="speed_plot_widgets_single_view")
            .skipif(
                conditions=[
                    never,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "title": "Speed",
            }
            | (params_dict.get("speed_plot_widgets_single_view") or {}),
            method="map",
            kwargs={
                "argnames": ["view", "data"],
                "argvalues": DependsOn("persist_speed_html_urls"),
            },
        ),
        "grouped_speed_plot_widget": Node(
            async_task=merge_widget_views.validate()
            .handle_errors(task_instance_id="grouped_speed_plot_widget")
            .set_executor("lithops"),
            partial={
                "widgets": DependsOn("speed_plot_widgets_single_view"),
            }
            | (params_dict.get("grouped_speed_plot_widget") or {}),
            method="call",
        ),
        "zip_collared_subject_values": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_collared_subject_values")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("split_relocs_by_group"),
                "right": DependsOn("persist_subject_season_wins"),
            }
            | (params_dict.get("zip_collared_subject_values") or {}),
            method="call",
        ),
        "generate_colared_subject_plot": Node(
            async_task=generate_collared_seasonal_plot.validate()
            .handle_errors(task_instance_id="generate_colared_subject_plot")
            .set_executor("lithops"),
            partial={
                "events_gdf": DependsOn("rename_event_cols"),
                "filter_col": "subject_name",
            }
            | (params_dict.get("generate_colared_subject_plot") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["relocations_gdf", "seasons_df"],
                "argvalues": DependsOn("zip_collared_subject_values"),
            },
        ),
        "persist_collared_subject_plots": Node(
            async_task=persist_text.validate()
            .handle_errors(task_instance_id="persist_collared_subject_plots")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_collared_subject_plots") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["text"],
                "argvalues": DependsOn("generate_colared_subject_plot"),
            },
        ),
        "collared_widget_view": Node(
            async_task=create_map_widget_single_view.validate()
            .handle_errors(task_instance_id="collared_widget_view")
            .skipif(
                conditions=[
                    never,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "title": "Collared Subject Plot",
            }
            | (params_dict.get("collared_widget_view") or {}),
            method="map",
            kwargs={
                "argnames": ["view", "data"],
                "argvalues": DependsOn("persist_collared_subject_plots"),
            },
        ),
        "grouped_collared_widget": Node(
            async_task=merge_widget_views.validate()
            .handle_errors(task_instance_id="grouped_collared_widget")
            .set_executor("lithops"),
            partial={
                "widgets": DependsOn("collared_widget_view"),
            }
            | (params_dict.get("grouped_collared_widget") or {}),
            method="call",
        ),
        "zip_mcp_asymp_values": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_mcp_asymp_values")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("split_relocs_by_group"),
                "right": DependsOn("persist_subject_season_wins"),
            }
            | (params_dict.get("zip_mcp_asymp_values") or {}),
            method="call",
        ),
        "generate_mcp_asymp_plot": Node(
            async_task=generate_seasonal_mcp_asymptote_plot.validate()
            .handle_errors(task_instance_id="generate_mcp_asymp_plot")
            .set_executor("lithops"),
            partial=(params_dict.get("generate_mcp_asymp_plot") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["relocations_gdf", "seasons_df"],
                "argvalues": DependsOn("zip_mcp_asymp_values"),
            },
        ),
        "persist_mcp_html_urls": Node(
            async_task=persist_text.validate()
            .handle_errors(task_instance_id="persist_mcp_html_urls")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_mcp_html_urls") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["text"],
                "argvalues": DependsOn("generate_mcp_asymp_plot"),
            },
        ),
        "mcp_plot_widgets_single_view": Node(
            async_task=create_map_widget_single_view.validate()
            .handle_errors(task_instance_id="mcp_plot_widgets_single_view")
            .skipif(
                conditions=[
                    never,
                ],
                unpack_depth=1,
            )
            .set_executor("lithops"),
            partial={
                "title": "MCP Asymptote",
            }
            | (params_dict.get("mcp_plot_widgets_single_view") or {}),
            method="map",
            kwargs={
                "argnames": ["view", "data"],
                "argvalues": DependsOn("persist_mcp_html_urls"),
            },
        ),
        "grouped_mcp_plot_widget": Node(
            async_task=merge_widget_views.validate()
            .handle_errors(task_instance_id="grouped_mcp_plot_widget")
            .set_executor("lithops"),
            partial={
                "widgets": DependsOn("mcp_plot_widgets_single_view"),
            }
            | (params_dict.get("grouped_mcp_plot_widget") or {}),
            method="call",
        ),
        "zip_traj_etd_gdf": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_traj_etd_gdf")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("generate_etd"),
                "right": DependsOn("split_trajs_by_group"),
            }
            | (params_dict.get("zip_traj_etd_gdf") or {}),
            method="call",
        ),
        "generate_subject_stats": Node(
            async_task=get_subject_stats.validate()
            .handle_errors(task_instance_id="generate_subject_stats")
            .set_executor("lithops"),
            partial={
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "subject_df": DependsOn("compute_subject_maturity"),
                "groupby_col": "subject_name",
            }
            | (params_dict.get("generate_subject_stats") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["etd_df", "traj_gdf"],
                "argvalues": DependsOn("zip_traj_etd_gdf"),
            },
        ),
        "persist_subject_stats": Node(
            async_task=persist_df.validate()
            .handle_errors(task_instance_id="persist_subject_stats")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_subject_stats") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("generate_subject_stats"),
            },
        ),
        "load_unfiltered_ldx": Node(
            async_task=load_landdx_aoi.validate()
            .handle_errors(task_instance_id="load_unfiltered_ldx")
            .set_executor("lithops"),
            partial={
                "map_path": DependsOn("retrieve_ldx_db"),
            }
            | (params_dict.get("load_unfiltered_ldx") or {}),
            method="call",
        ),
        "zip_etd_subjects": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_etd_subjects")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("generate_etd"),
                "right": DependsOn("split_subject_by_group"),
            }
            | (params_dict.get("zip_etd_subjects") or {}),
            method="call",
        ),
        "build_region_lookup": Node(
            async_task=build_template_region_lookup.validate()
            .handle_errors(task_instance_id="build_region_lookup")
            .set_executor("lithops"),
            partial={
                "gdf": DependsOn("load_unfiltered_ldx"),
            }
            | (params_dict.get("build_region_lookup") or {}),
            method="call",
        ),
        "comp_template_regions": Node(
            async_task=compute_template_regions.validate()
            .handle_errors(task_instance_id="comp_template_regions")
            .set_executor("lithops"),
            partial={
                "geodataframe": DependsOn("load_unfiltered_ldx"),
                "template_lookup": DependsOn("build_region_lookup"),
                "crs": "ESRI:53042",
            }
            | (params_dict.get("comp_template_regions") or {}),
            method="call",
        ),
        "process_subject_occupancy": Node(
            async_task=compute_subject_occupancy.validate()
            .handle_errors(task_instance_id="process_subject_occupancy")
            .set_executor("lithops"),
            partial={
                "crs": "ESRI:53042",
                "regions_gdf": DependsOn("comp_template_regions"),
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("process_subject_occupancy") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["etd_gdf", "subjects_df"],
                "argvalues": DependsOn("zip_etd_subjects"),
            },
        ),
        "persist_subject_occupancy": Node(
            async_task=persist_df.validate()
            .handle_errors(task_instance_id="persist_subject_occupancy")
            .set_executor("lithops"),
            partial={
                "root_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("persist_subject_occupancy") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["df"],
                "argvalues": DependsOn("process_subject_occupancy"),
            },
        ),
        "convt_range_html_png": Node(
            async_task=html_to_png.validate()
            .handle_errors(task_instance_id="convt_range_html_png")
            .set_executor("lithops"),
            partial={
                "output_dir": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "config": {"wait_for_timeout": 100, "width": 765, "height": 525},
            }
            | (params_dict.get("convt_range_html_png") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["html_path"],
                "argvalues": DependsOn("persist_hr_ecomap_urls"),
            },
        ),
        "convt_speedmap_html_png": Node(
            async_task=html_to_png.validate()
            .handle_errors(task_instance_id="convt_speedmap_html_png")
            .set_executor("lithops"),
            partial={
                "output_dir": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "config": {"wait_for_timeout": 100, "width": 765, "height": 525},
            }
            | (params_dict.get("convt_speedmap_html_png") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["html_path"],
                "argvalues": DependsOn("persist_speed_ecomap_urls"),
            },
        ),
        "convt_seasons_html_png": Node(
            async_task=html_to_png.validate()
            .handle_errors(task_instance_id="convt_seasons_html_png")
            .set_executor("lithops"),
            partial={
                "output_dir": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "config": {"wait_for_timeout": 100, "width": 602, "height": 855},
            }
            | (params_dict.get("convt_seasons_html_png") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["html_path"],
                "argvalues": DependsOn("season_etd_ecomap_html_url"),
            },
        ),
        "convt_nsdp_html_png": Node(
            async_task=html_to_png.validate()
            .handle_errors(task_instance_id="convt_nsdp_html_png")
            .set_executor("lithops"),
            partial={
                "output_dir": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "config": {"wait_for_timeout": 100, "width": 2238, "height": 450},
            }
            | (params_dict.get("convt_nsdp_html_png") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["html_path"],
                "argvalues": DependsOn("persist_nsd_html_urls"),
            },
        ),
        "convt_mcp_html_png": Node(
            async_task=html_to_png.validate()
            .handle_errors(task_instance_id="convt_mcp_html_png")
            .set_executor("lithops"),
            partial={
                "output_dir": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "config": {"wait_for_timeout": 100, "width": 2238, "height": 450},
            }
            | (params_dict.get("convt_mcp_html_png") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["html_path"],
                "argvalues": DependsOn("persist_mcp_html_urls"),
            },
        ),
        "convt_speedp_html_png": Node(
            async_task=html_to_png.validate()
            .handle_errors(task_instance_id="convt_speedp_html_png")
            .set_executor("lithops"),
            partial={
                "output_dir": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "config": {"wait_for_timeout": 100, "width": 2238, "height": 450},
            }
            | (params_dict.get("convt_speedp_html_png") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["html_path"],
                "argvalues": DependsOn("persist_speed_html_urls"),
            },
        ),
        "convt_colev_html_png": Node(
            async_task=html_to_png.validate()
            .handle_errors(task_instance_id="convt_colev_html_png")
            .set_executor("lithops"),
            partial={
                "output_dir": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "config": {"wait_for_timeout": 100, "width": 2238, "height": 450},
            }
            | (params_dict.get("convt_colev_html_png") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["html_path"],
                "argvalues": DependsOn("persist_collared_subject_plots"),
            },
        ),
        "zip_movement_range_maps": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_movement_range_maps")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("convt_speedmap_html_png"),
                "right": DependsOn("convt_range_html_png"),
            }
            | (params_dict.get("zip_movement_range_maps") or {}),
            method="call",
        ),
        "zip_range_mov_overview": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_range_mov_overview")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("zip_movement_range_maps"),
                "right": DependsOn("convt_seasons_html_png"),
            }
            | (params_dict.get("zip_range_mov_overview") or {}),
            method="call",
        ),
        "zip_range_subject_photo": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_range_subject_photo")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("zip_range_mov_overview"),
                "right": DependsOn("download_profile_pic"),
            }
            | (params_dict.get("zip_range_subject_photo") or {}),
            method="call",
        ),
        "zip_items_w_collared": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_items_w_collared")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("zip_range_subject_photo"),
                "right": DependsOn("convt_colev_html_png"),
            }
            | (params_dict.get("zip_items_w_collared") or {}),
            method="call",
        ),
        "zip_with_nsd": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_with_nsd")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("zip_items_w_collared"),
                "right": DependsOn("convt_nsdp_html_png"),
            }
            | (params_dict.get("zip_with_nsd") or {}),
            method="call",
        ),
        "zip_with_speed": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_with_speed")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("zip_with_nsd"),
                "right": DependsOn("convt_speedp_html_png"),
            }
            | (params_dict.get("zip_with_speed") or {}),
            method="call",
        ),
        "zip_with_mcp": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_with_mcp")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("zip_with_speed"),
                "right": DependsOn("convt_mcp_html_png"),
            }
            | (params_dict.get("zip_with_mcp") or {}),
            method="call",
        ),
        "zip_subject_info": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_subject_info")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("zip_with_mcp"),
                "right": DependsOn("persist_subject_info"),
            }
            | (params_dict.get("zip_subject_info") or {}),
            method="call",
        ),
        "zip_subject_stats": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_subject_stats")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("zip_subject_info"),
                "right": DependsOn("persist_subject_stats"),
            }
            | (params_dict.get("zip_subject_stats") or {}),
            method="call",
        ),
        "zip_occupancy_info": Node(
            async_task=zip_grouped_by_key.validate()
            .handle_errors(task_instance_id="zip_occupancy_info")
            .set_executor("lithops"),
            partial={
                "left": DependsOn("zip_subject_stats"),
                "right": DependsOn("persist_subject_occupancy"),
            }
            | (params_dict.get("zip_occupancy_info") or {}),
            method="call",
        ),
        "flatten_collared_context": Node(
            async_task=flatten_tuple.validate()
            .handle_errors(task_instance_id="flatten_collared_context")
            .set_executor("lithops"),
            partial=(params_dict.get("flatten_collared_context") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["nested"],
                "argvalues": DependsOn("zip_occupancy_info"),
            },
        ),
        "view_flatten_data": Node(
            async_task=print_output.validate()
            .handle_errors(task_instance_id="view_flatten_data")
            .set_executor("lithops"),
            partial={
                "value": DependsOn("flatten_collared_context"),
            }
            | (params_dict.get("view_flatten_data") or {}),
            method="call",
        ),
        "generate_report_context": Node(
            async_task=report_context.validate()
            .handle_errors(task_instance_id="generate_report_context")
            .set_executor("lithops"),
            partial={
                "subjects_df": DependsOn("compute_subject_maturity"),
                "templates": DependsOnSequence(
                    [
                        DependsOn("download_template_one"),
                        DependsOn("download_template_two"),
                        DependsOn("download_template_three"),
                    ],
                ),
                "input_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "logo": DependsOn("download_logo"),
            }
            | (params_dict.get("generate_report_context") or {}),
            method="mapvalues",
            kwargs={
                "argnames": [
                    "movement_ecomap",
                    "range_ecomap",
                    "overview_ecomap",
                    "subject_photo",
                    "collar_event_timeline_plot",
                    "nsd_plot",
                    "speed_plot",
                    "mcp_plot",
                    "subject_info",
                    "subject_stats",
                    "occupancy_info",
                ],
                "argvalues": DependsOn("flatten_collared_context"),
            },
        ),
        "render_html_pdf": Node(
            async_task=render_html_to_pdf.validate()
            .handle_errors(task_instance_id="render_html_pdf")
            .set_executor("lithops"),
            partial={
                "pdf_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
            }
            | (params_dict.get("render_html_pdf") or {}),
            method="mapvalues",
            kwargs={
                "argnames": ["html_path"],
                "argvalues": DependsOn("generate_report_context"),
            },
        ),
        "merge_subject_pdf": Node(
            async_task=merge_pdfs.validate()
            .handle_errors(task_instance_id="merge_subject_pdf")
            .set_executor("lithops"),
            partial={
                "subject_df": DependsOn("compute_subject_maturity"),
                "output_path": os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
                "filename": "Collared Elephants Report",
                "pdf_path_items": DependsOn("render_html_pdf"),
            }
            | (params_dict.get("merge_subject_pdf") or {}),
            method="call",
        ),
        "collared_report_template": Node(
            async_task=gather_dashboard.validate()
            .handle_errors(task_instance_id="collared_report_template")
            .set_executor("lithops"),
            partial={
                "details": DependsOn("workflow_details"),
                "widgets": DependsOnSequence(
                    [
                        DependsOn("merge_speed_ecomap_widgets"),
                        DependsOn("merge_hr_ecomap_widgets"),
                        DependsOn("season_grouped_map_widget"),
                        DependsOn("grouped_nsd_plot_widget"),
                        DependsOn("grouped_speed_plot_widget"),
                        DependsOn("grouped_collared_widget"),
                        DependsOn("grouped_mcp_plot_widget"),
                    ],
                ),
                "time_range": DependsOn("define_time_range"),
                "groupers": DependsOn("configure_grouping_strategy"),
            }
            | (params_dict.get("collared_report_template") or {}),
            method="call",
        ),
    }
    graph = Graph(dependencies=dependencies, nodes=nodes)
    results = graph.execute()
    return results
